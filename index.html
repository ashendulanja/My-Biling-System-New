<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Business Pro Invoice</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0f172a;       
            --secondary: #3b82f6;     
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --bg-body: #f1f5f9;
            --white: #ffffff;
            --logo-width: 150px;
            --sign-width: 120px;
            --row-alt-bg: rgba(15, 23, 42, 0.02); 
            --theme-fade: rgba(15, 23, 42, 0.04);
        }

        body { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; background: var(--bg-body); margin: 0; padding: 20px; color: var(--text-main); -webkit-user-select: none; user-select: none; }
        .app-container { display: flex; gap: 30px; max-width: 1600px; margin: auto; align-items: flex-start; }
        
        /* --- CONTROLS UI --- */
        .controls { flex: 1.1; background: var(--white); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); position: sticky; top: 20px; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border);}
        
        .profile-header { background: #f8fafc; padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 15px;}
        .profile-header select { flex: 1; padding: 10px; font-weight: 700; border-radius: 8px; border: 2px solid var(--primary); color: var(--primary); font-size: 14px; cursor: pointer; background: var(--white);}
        .btn-save-profile { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s;}
        .btn-save-profile:hover { opacity: 0.9; }

        .tabs { display: flex; background: var(--white); border-bottom: 1px solid var(--border); flex-wrap: wrap;}
        .tab-btn { flex: 1; padding: 14px 10px; text-align: center; font-weight: 700; color: var(--text-muted); cursor: pointer; border: none; background: transparent; transition: all 0.2s; font-size: 13px; font-family: inherit; white-space: nowrap;}
        .tab-btn.active { color: var(--primary); box-shadow: inset 0 -3px 0 var(--primary); background: #f8fafc;}
        .tab-btn:hover:not(.active) { background: #f1f5f9; }

        .tab-content { padding: 25px; overflow-y: auto; flex: 1; display: none; }
        .tab-content.active { display: block; }
        .tab-content::-webkit-scrollbar { width: 5px; }
        .tab-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .control-group { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .control-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .control-group h3 { margin-top: 0; color: var(--primary); font-size: 13px; margin-bottom: 15px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;}
        
        label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
        input[type="text"], input[type="number"], input[type="date"], input[type="password"], select, textarea { width: 100%; padding: 10px 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 13px; color: var(--text-main); transition: all 0.2s; background: #f8fafc;}
        input:focus, select:focus, textarea:focus { border-color: var(--secondary); outline: none; background: var(--white); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        textarea { resize: vertical; height: 60px; }
        
        .color-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .color-box { flex: 1; }
        input[type="color"] { width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer; padding: 0; background: none;}
        input[type="range"] { width: 100%; margin-bottom: 15px; cursor: pointer; accent-color: var(--primary); }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 12px; border-radius: 8px; border: 1px solid #bfdbfe;}
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: var(--secondary); }
        .checkbox-wrapper label { margin: 0; font-size: 14px; color: var(--primary); cursor: pointer; }

        .btn { background: var(--primary); color: var(--white); border: none; padding: 14px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.2s; font-family: inherit;}
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-add { background: var(--white); color: var(--primary); border: 1px solid var(--primary); }
        .btn-add:hover { background: var(--primary); color: white; }
        .btn-print { margin: 20px 25px 25px 25px; width: calc(100% - 50px); background: #10b981; }
        .btn-print:hover { background: #059669; }

        .item-entry-box { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.3s;}

        /* --- PREVIEW UI (BASE STRUCTURE FOR ALL TEMPLATES) --- */
        .preview { flex: 1.5; background: var(--white); border-radius: 0; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); min-height: 1123px; width: 794px; box-sizing: border-box; position: relative; display: flex; flex-direction: column; overflow: visible;}
        
        #printRoot { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--white); }
        
        /* TPL-1: Default Modern Corporate */
        .tpl-1 .top-accent { height: 8px; width: 100%; background: var(--primary); }
        .preview-content { padding: 45px 50px; flex: 1; display: flex; flex-direction: column; }

        .header-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 35px; border-bottom: 2px solid var(--theme-fade); padding-bottom: 25px;} 
        .logo-container img { width: var(--logo-width); max-height: 85px; object-fit: contain; }
        #logoTextFallback { margin:0; color:var(--primary); font-size: 32px; font-weight:800; letter-spacing:-1px; text-transform: uppercase;}
        
        .doc-title-wrapper { text-align: right; }
        .doc-title { font-size: 38px; color: var(--primary); margin: 0 0 5px 0; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; line-height: 1;}
        .doc-number { font-size: 16px; color: var(--secondary); font-weight: 700; letter-spacing: 0.5px; margin-bottom: 15px;}
        
        .doc-dates { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
        .date-line { font-size: 13px; color: var(--text-main); background: #f8fafc; padding: 4px 12px; border-radius: 6px; display: inline-block;}
        .date-line strong { color: var(--text-muted); font-weight: 600; margin-right: 5px;}

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .info-card { padding: 0; }
        .info-card h4 { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin: 0 0 8px 0; font-weight: 800; }
        .info-title { font-size: 16px; font-weight: 800; color: var(--primary); margin: 0 0 6px 0; }
        .info-text { font-size: 13px; color: var(--text-main); line-height: 1.6; white-space: pre-line; }

        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 20px; }
        .modern-table th { background: var(--theme-fade); color: var(--primary); padding: 12px 15px; text-align: left; font-weight: 700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border);}
        .modern-table th:first-child { border-top-left-radius: 8px; }
        .modern-table th.total-col { border-top-right-radius: 8px; } 
        .modern-table th.action-col { background: transparent; border: none; width: 55px; padding: 0;}
        
        .modern-table td { padding: 12px 15px; vertical-align: top; border-bottom: 1px solid var(--border); font-size: 13px; background-color: var(--white); }
        .modern-table tbody tr:nth-child(even) td { background-color: var(--row-alt-bg); }
        .modern-table tbody tr:last-child td { border-bottom: none; }
        
        .text-right { text-align: right !important; }
        .text-center { text-align: center !important; }
        
        .item-main { font-weight: 700; display: block; margin-bottom: 3px; color: var(--primary); font-size: 13.5px;}
        .item-sub { font-size: 12px; color: var(--text-muted); white-space: pre-line; display: block;}
        .warranty-badge { display: inline-block; color: var(--secondary); font-size: 10px; padding: 2px 8px; border-radius: 20px; font-weight: 700; margin-top: 5px; background: rgba(59, 130, 246, 0.1);}

        .summary-section { display: flex; justify-content: flex-end; margin-top: 10px; margin-bottom: 30px;}
        .summary-box { width: 320px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13.5px; color: var(--text-main); padding: 0 15px;}
        .summary-row.discount-row { color: #ef4444; font-weight: 600; }
        
        .summary-total { display: flex; justify-content: space-between; margin-top: 12px; padding: 15px; background: var(--primary); border-radius: 8px; font-size: 18px; font-weight: 800; color: var(--white); box-shadow: 0 4px 6px rgba(0,0,0,0.1);}

        .bottom-section { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: flex-end; padding-top: 20px; border-top: 2px solid var(--theme-fade);}
        
        .bank-details-box { display: flex; align-items: center; gap: 15px; background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; padding: 15px; width: 100%; box-sizing: border-box; margin-bottom: 15px;}
        .bank-logo-area { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: var(--white); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; flex-shrink: 0;}
        .bank-logo-area img { max-width: 100%; max-height: 100%; object-fit: contain; padding: 4px;}
        .bank-logo-area i { font-size: 24px; color: var(--text-muted); font-style: normal;}
        .bank-info-area { flex: 1; }
        .bank-info-area h4 { margin: 0 0 6px 0; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 800; }
        .bank-info-line { font-size: 11.5px; color: var(--text-main); margin-bottom: 3px; display: flex; justify-content: space-between; gap: 10px;}
        .bank-info-line strong { font-weight: 700; color: var(--primary); text-align: right;}

        .notes-area h4 { margin: 0 0 6px 0; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 800;}
        .notes-area p { margin: 0; font-size: 12px; color: var(--text-main); font-weight: 500; white-space: pre-line; line-height: 1.5;}
        
        .signature-area { text-align: right; width: 100%; display: flex; flex-direction: column; align-items: flex-end;}
        .sig-image-container { height: 70px; display: flex; align-items: flex-end; justify-content: flex-end; margin-bottom: 8px; width: 100%;}
        .sig-image-container img { width: var(--sign-width); max-height: 70px; object-fit: contain; }
        .sig-line { border-top: 2px solid var(--border); padding-top: 8px; font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; width: 200px; text-align: center;}

        .electronic-sig-text { text-align: right; width: 100%; }
        .electronic-sig-text p { font-size: 11px; color: var(--text-muted); font-style: italic; margin: 0; line-height: 1.5; }

        /* ACTION BUTTONS */
        .del-btn, .edit-btn { background: transparent; border: none; padding: 6px; font-size: 14px; cursor: pointer; transition: 0.2s; opacity: 0;}
        .del-btn { color: #ef4444; }
        .edit-btn { color: var(--secondary); }
        tr:hover .del-btn, tr:hover .edit-btn { opacity: 1; }
        .del-btn:hover, .edit-btn:hover { transform: scale(1.15); }

        /* DB & HISTORY UI */
        .db-list-item { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f8fafc; border:1px solid var(--border); margin-bottom:8px; border-radius:8px;}
        .search-bar { border: 1px solid var(--secondary) !important; background: var(--white) !important; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}

        .hist-card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 12px; transition: all 0.2s; cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
        .hist-card:hover { border-color: var(--secondary); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transform: translateY(-2px); }
        .hist-info h4 { margin: 0 0 5px 0; color: var(--primary); font-size: 15px; font-weight: 800;}
        .hist-info p { margin: 0; font-size: 12px; color: var(--text-muted); font-weight: 600;}
        .hist-meta { text-align: right; }
        .hist-meta .hist-total { font-size: 15px; font-weight: 800; color: var(--primary); margin-bottom: 5px; display: block;}
        .hist-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; background: #e0f2fe; color: #0284c7;}
        .hist-badge.quo { background: #fef3c7; color: #d97706; }

        /* CUSTOM MODAL CSS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px);}
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; padding: 25px; border-radius: 16px; width: 350px; max-width: 90%; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.show .modal-box { transform: translateY(0); }
        .modal-box h3 { margin-top: 0; color: var(--primary); margin-bottom: 10px; font-size: 18px; font-weight: 800;}
        .modal-box p { color: var(--text-muted); font-size: 14px; margin-bottom: 25px; line-height: 1.5; font-weight: 500;}
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-family: inherit; font-size: 13px; flex: 1; transition: 0.2s;}
        .modal-btn:hover { opacity: 0.9; transform: translateY(-1px);}
        .modal-btn-cancel { background: #f1f5f9; color: var(--text-main); }
        .modal-btn-confirm { background: var(--secondary); color: white; }
        .modal-btn-danger { background: #ef4444; color: white; }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 1024px) {
            body { padding: 10px; }
            .app-container { flex-direction: column; }
            .controls { width: 100%; max-height: none; position: static; box-shadow: 0 2px 10px rgba(0,0,0,0.1);}
            .tabs { overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
            .tab-btn { flex: 0 0 auto; padding: 15px 20px; }
            
            .preview { width: 100%; min-height: auto; overflow-x: auto; box-shadow: none; border: 1px solid var(--border); border-radius: 12px; margin-top: 20px;}
            #printRoot { min-width: 794px; /* Force A4 width internally to preserve design */ transform: scale(0.9); transform-origin: top left; }
        }

        @media (max-width: 768px) {
            #printRoot { transform: scale(0.65); width: 150%; }
            .profile-header { flex-direction: column; align-items: stretch; }
            .profile-header select { width: 100%; }
            .info-grid { grid-template-columns: 1fr; gap: 15px; }
            .bottom-section { grid-template-columns: 1fr; gap: 20px; }
            .signature-area { align-items: flex-start; text-align: left; margin-top: 20px;}
            .sig-image-container { justify-content: flex-start; }
            .sig-line { text-align: left; }
        }
        
        @media (max-width: 480px) {
            #printRoot { transform: scale(0.45); width: 220%; }
        }

        @media print {
            body { padding: 0; background: var(--white); }
            .app-container { display: block; max-width: none; margin: 0; }
            .controls { display: none; }
            .preview { box-shadow: none; margin: 0; width: 100%; min-height: auto; padding: 0; border: none;}
            #printRoot { transform: none !important; width: 100% !important; min-height: 100vh; }
            .preview-content { padding: 10mm; } 
            .del-btn, .edit-btn, .action-col { display: none !important; }
            
            .modern-table th.total-col { border-top-right-radius: 6px !important; border-bottom-right-radius: 6px !important;}
            
            .summary-total, .modern-table th, .top-accent, .bank-details-box, .bank-logo-area, .warranty-badge, .modern-table tbody tr:nth-child(even) td, .info-card { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            
            .header-section { page-break-inside: avoid; }
            .info-grid { page-break-inside: avoid; }
            .summary-section { page-break-inside: avoid; }
            .bank-details-box { page-break-inside: avoid; }
            .bottom-section { page-break-inside: avoid; }
            #notesAreaContainer1, #notesAreaContainer2 { page-break-inside: avoid; }
            
            @page { margin: 5mm; }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="controls">
        <div class="profile-header">
            <select id="profileSelect" onchange="loadProfile()"></select>
            <button class="btn-save-profile" onclick="saveProfile()" title="Save current settings to this profile">üíæ Save Settings</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('editorTab', this)">üìù Invoice</button>
            <button class="tab-btn" onclick="switchTab('historyTab', this)">üìÑ History</button>
            <button class="tab-btn" onclick="switchTab('dbTab', this)">üóÑÔ∏è Database</button>
            <button class="tab-btn" onclick="switchTab('bankTab', this)">üè¶ Bank</button>
            <button class="tab-btn" onclick="switchTab('settingsTab', this)">üé® Settings</button>
        </div>

        <div id="editorTab" class="tab-content active">
            <div class="control-group">
                <h3>Document Details</h3>
                <div style="display: flex; gap: 10px;">
                    <select id="docType" onchange="handleDocTypeChange()" style="flex: 1;">
                        <option value="INVOICE">Invoice</option>
                        <option value="QUOTATION">Quotation</option>
                    </select>
                    <input type="text" id="docNo" oninput="updateView()" style="flex: 1.5;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label>Date:</label><input type="date" id="docDate" oninput="handleDocDateChange()"></div>
                    <div style="flex: 1;" id="validDateControl"><label>Valid Until:</label><input type="date" id="validDate" oninput="updateView()"></div>
                </div>
            </div>

            <div class="control-group">
                <h3>Customer (Bill To)</h3>
                <input type="text" id="custName" list="custDatalist" placeholder="Search or Type Customer Name" oninput="autoFillCustomer(); updateView()">
                <datalist id="custDatalist"></datalist>
                <textarea id="custAddress" placeholder="Customer Address & Contact..." oninput="updateView()"></textarea>
            </div>

            <div class="control-group item-entry-box" id="itemInputBox">
                <h3 style="color: var(--primary);" id="itemEntryTitle">Add Item</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="itemName" list="itemDatalist" placeholder="Search or Type Item Name" style="flex: 2; margin-bottom: 0;" oninput="autoFillItem()">
                    <datalist id="itemDatalist"></datalist>
                    
                    <select id="itemWarrantySelect" onchange="handleWarrantyChange()" style="flex: 1; margin-bottom: 0;">
                        <option value="1 Year Warranty" selected>1 Year</option>
                        <option value="2 Years Warranty">2 Years</option>
                        <option value="3 Years Warranty">3 Years</option>
                        <option value="6 Months Warranty">6 Months</option>
                        <option value="3 Months Warranty">3 Months</option>
                        <option value="none">No Warranty</option>
                        <option value="custom">Custom...</option>
                    </select>
                </div>
                <input type="text" id="itemWarrantyCustom" placeholder="Type custom warranty here..." style="display: none; margin-bottom: 10px;">
                
                <textarea id="itemDesc" placeholder="Description / Serial No..."></textarea>
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1.5;"><label>Price (LKR)</label><input type="number" id="itemPrice" placeholder="0.00"></div>
                    <div style="flex: 1.5;"><label>Unit Discount</label><input type="number" id="itemDiscount" placeholder="0.00"></div>
                    <div style="flex: 1;"><label>Qty</label><input type="number" id="itemQty" value="1"></div>
                </div>
                <button class="btn btn-add" id="itemActionBtn" onclick="handleItemAction()">+ Add to List</button>
            </div>

            <div class="control-group" style="border:none;">
                <h3>Extra Information</h3>
                <label>Note Section 1 - Heading:</label>
                <input type="text" id="note1Heading" placeholder="e.g. Notes" oninput="updateView()">
                <textarea id="notes" placeholder="Payment terms, Bank Details..." oninput="updateView()"></textarea>
                
                <div style="margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 15px;">
                    <label>Note Section 2 - Heading (Optional):</label>
                    <input type="text" id="note2Heading" placeholder="e.g. Terms & Conditions" oninput="updateView()">
                    <textarea id="note2Text" placeholder="Add extra notes or terms here. Leave blank to hide." oninput="updateView()"></textarea>
                </div>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="control-group" style="border: none;">
                <h3>Saved Documents History</h3>
                <p style="font-size: 12px; color: var(--text-muted); margin-top:-10px;">All generated invoices are saved locally here. Click one to reload it.</p>
                <input type="text" id="histSearch" class="search-bar" placeholder="üîç Search by Customer Name or Doc No..." oninput="renderHistory()">
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div style="flex: 1;"><label>From Date</label><input type="date" id="histFrom" onchange="renderHistory()"></div>
                    <div style="flex: 1;"><label>To Date</label><input type="date" id="histTo" onchange="renderHistory()"></div>
                    <div style="flex: 0.4; display:flex; align-items:flex-end;">
                        <button class="btn btn-add" style="padding: 10px; margin-bottom: 15px;" onclick="clearHistFilters()">Clear</button>
                    </div>
                </div>
                <div id="historyListContainer" style="max-height: 500px; overflow-y: auto; padding-right: 5px;"></div>
            </div>
        </div>

        <div id="dbTab" class="tab-content">
            <div class="control-group">
                <h3>Customer Database</h3>
                <input type="text" id="searchCustDB" class="search-bar" placeholder="üîç Search Customers..." oninput="renderDBLists()">
                <input type="text" id="dbCustName" placeholder="Customer Name">
                <textarea id="dbCustAddress" placeholder="Customer Address & Contact Info"></textarea>
                <button class="btn btn-add" onclick="saveCustomerDB()">+ Save Customer</button>
                <div id="customerDBList" style="margin-top: 15px; max-height: 250px; overflow-y: auto;"></div>
            </div>
            <div class="control-group" style="border:none;">
                <h3>Item Database</h3>
                <input type="text" id="searchItemDB" class="search-bar" placeholder="üîç Search Items..." oninput="renderDBLists()">
                <input type="text" id="dbItemName" placeholder="Item Name">
                <textarea id="dbItemDesc" placeholder="Default Description"></textarea>
                <input type="number" id="dbItemPrice" placeholder="Default Price (LKR)">
                <button class="btn btn-add" onclick="saveItemDB()">+ Save Item</button>
                <div id="itemDBList" style="margin-top: 15px; max-height: 250px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="bankTab" class="tab-content">
            <div class="control-group" style="border:none;">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="showBank" onchange="updateView()" checked>
                    <label for="showBank"><strong>Show Bank Details on Invoice</strong></label>
                </div>
                <div id="bankInputs">
                    <label>Bank Logo Image (Square PNG/JPG):</label>
                    <input type="file" id="bankLogoInput" accept="image/*" onchange="loadBankLogo(event)" style="padding: 10px; background:#fff;">
                    <label>Bank Name:</label><input type="text" id="bankName" placeholder="e.g. Commercial Bank" oninput="updateView()">
                    <label>Account Name:</label><input type="text" id="accName" placeholder="e.g. NexaTag Solutions" oninput="updateView()">
                    <label>Account Number:</label><input type="text" id="accNo" placeholder="e.g. 1000 2345 6789" oninput="updateView()">
                    <label>Branch:</label><input type="text" id="bankBranch" placeholder="e.g. Kurunegala Branch" oninput="updateView()">
                </div>
            </div>
        </div>

        <div id="settingsTab" class="tab-content">
            
            <div class="control-group">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                    <h3 style="margin:0;">Premium Features</h3>
                    <span style="background:#fef3c7; color:#d97706; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:800; letter-spacing:0.5px;">PRO</span>
                </div>

                <div id="_0xLck" style="background: #eff6ff; padding: 25px; border-radius: 12px; border: 1px dashed var(--secondary); text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 28px; margin-bottom: 5px;">üîí</div>
                    <h4 style="margin: 0 0 5px 0; color: var(--primary);">Feature Locked</h4>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">Please login with a premium account to unlock Pro Templates & Profile Management.</p>

                    <div style="position: relative; max-width: 260px; margin: 0 auto 15px auto;">
                        <input type="text" id="_0xUinp" placeholder="Username" oninput="window['_0xChkU']()" style="margin-bottom:0; text-align: center; font-weight:bold;">
                        <span id="_0xTick" style="position: absolute; right: -30px; top: 12px; font-size: 16px; display: none;">‚úÖ</span>
                    </div>
                    <input type="password" id="_0xPinp" placeholder="Password" style="max-width: 260px; margin: 0 auto 15px auto; display: block; text-align: center;">
                    <button class="btn btn-add" style="max-width: 260px; background: var(--secondary); color: white; border: none; box-shadow: 0 4px 6px rgba(59,130,246,0.3);" onclick="window['_0xUnlck']()">Unlock Premium</button>
                </div>

                <label>Choose Invoice Template:</label>
                <select id="tplSelect" onchange="updateTemplate(true)" style="margin-bottom: 15px; border: 2px solid var(--secondary); font-weight: bold; color: var(--primary);">
                    <option value="tpl-1">Default - Modern Corporate</option>
                    <option value="tpl-2">Premium - Blue Angled Header üîí</option>
                    <option value="tpl-3">Premium - Dark Elegant Abstract üîí</option>
                    <option value="tpl-4">Premium - Purple Curved Overlay üîí</option>
                    <option value="tpl-5">Premium - Minimal Clean Lines üîí</option>
                </select>

                <label>Manage Business Profiles:</label>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-add" style="padding: 10px;" onclick="addNewProfile()">‚ûï Add Profile</button>
                    <button class="btn btn-add" style="padding: 10px;" onclick="renameCurrentProfile()">‚úèÔ∏è Rename</button>
                    <button class="btn" style="padding: 10px; background: #ef4444; border: none; flex: 0.5;" onclick="deleteCurrentProfile()">üóëÔ∏è Delete</button>
                </div>
            </div>

            <div class="control-group">
                <h3>Business Details (From)</h3>
                <input type="text" id="compName" placeholder="Business Name" oninput="updateView()">
                <textarea id="compAddress" placeholder="Address, Phone, Email..." oninput="updateView()"></textarea>
            </div>

            <div class="control-group">
                <h3>Theme Colors</h3>
                <p style="font-size: 12px; color: #64748b; margin-top: 0;">Keep it clean. Use your brand's main color as Primary.</p>
                <div class="color-row">
                    <div class="color-box">
                        <label>Primary (Main)</label>
                        <input type="color" id="primaryColor" oninput="updateTheme()">
                    </div>
                    <div class="color-box">
                        <label>Secondary (Accent Line)</label>
                        <input type="color" id="secondaryColor" oninput="updateTheme()">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h3>Company Logo</h3>
                <input type="file" id="logoInput" accept="image/*" onchange="loadLogo(event)" style="padding: 10px; background:#fff;">
                <label>Logo Size:</label>
                <input type="range" id="logoSize" min="50" max="300" value="140" oninput="updateTheme()">
            </div>

            <div class="control-group" style="border:none;">
                <h3>Signature Settings</h3>
                <select id="sigType" onchange="updateSignatureDisplay()">
                    <option value="upload">Upload Authorized Signature</option>
                    <option value="electronic">Electronic Text (No Signature)</option>
                </select>

                <div id="sigUploadControls" style="margin-top: 15px;">
                    <label>Upload Image (PNG):</label>
                    <input type="file" id="sigInput" accept="image/*" onchange="loadSignature(event)" style="padding: 10px; background:#fff;">
                    <label>Signature Size:</label>
                    <input type="range" id="sigSize" min="50" max="250" value="120" oninput="updateTheme()">
                </div>
            </div>
        </div>

        <button class="btn btn-print" onclick="initiatePrintAndSave()">Print & Save Document</button>
    </div>

    <div class="preview">
        <div id="printRoot" class="tpl-1">
            <div class="top-accent"></div>
            <div class="preview-content">
                
                <div class="header-section">
                    <div class="logo-container">
                        <img id="logoPreview" src="" style="display:none;" alt="Logo">
                        <h2 id="logoTextFallback">Business Name</h2>
                    </div>
                    
                    <div class="doc-title-wrapper">
                        <h1 class="doc-title" id="displayDocType">INVOICE</h1>
                        <div class="doc-number" id="displayDocNo">INV-1001</div>
                        
                        <div class="doc-dates">
                            <div class="date-line"><strong>Date:</strong> <span id="displayDate"></span></div>
                            <div class="date-line" id="displayValidDateArea" style="display:none;"><strong>Valid Until:</strong> <span id="displayValidDate"></span></div>
                        </div>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <h4>From</h4>
                        <div class="info-title" id="displayCompName">Business Name</div>
                        <div class="info-text" id="displayCompAddress">-</div>
                    </div>

                    <div class="info-card text-right">
                        <h4>Bill To</h4>
                        <div class="info-title" id="displayCustName">Customer Name</div>
                        <div class="info-text" id="displayCustAddress">-</div>
                    </div>
                </div>

                <table class="modern-table">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>

                <div class="summary-section">
                    <div class="summary-box">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="subTotal">LKR 0.00</span>
                        </div>
                        <div class="summary-row discount-row" id="discountRow" style="display: none;">
                            <span>Discount</span>
                            <span id="totalDiscountAmt">- LKR 0.00</span>
                        </div>
                        <div class="summary-total">
                            <span>Total Amount</span>
                            <span id="grandTotal">LKR 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="bottom-section">
                    <div style="flex:1;">
                        <div class="bank-details-box" id="bankDisplayBox" style="display: none;">
                            <div class="bank-logo-area">
                                <img id="bankLogoPreview" src="" style="display:none;" alt="Bank">
                                <i id="bankLogoFallback">üè¶</i>
                            </div>
                            <div class="bank-info-area">
                                <h4>Payment Details</h4>
                                <div class="bank-info-line"><span>Bank:</span> <strong id="dispBankName">-</strong></div>
                                <div class="bank-info-line"><span>Acc Name:</span> <strong id="dispAccName">-</strong></div>
                                <div class="bank-info-line"><span>Acc No:</span> <strong id="dispAccNo">-</strong></div>
                                <div class="bank-info-line"><span>Branch:</span> <strong id="dispBranch">-</strong></div>
                            </div>
                        </div>

                        <div class="notes-area">
                            <div id="notesAreaContainer1">
                                <h4 id="dispNote1Heading">Notes</h4>
                                <p id="displayNotes"></p>
                            </div>
                            <div id="notesAreaContainer2" style="margin-top: 15px; display: none;">
                                <h4 id="dispNote2Heading">Terms & Conditions</h4>
                                <p id="displayNote2Text"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="signature-area" id="sigAreaImage" style="flex:1;">
                        <div class="sig-image-container">
                            <img id="sigPreview" src="" style="display:none;" alt="Signature">
                        </div>
                        <div class="sig-line">Authorized Signature</div>
                    </div>

                    <div class="electronic-sig-text" id="sigAreaText" style="display:none;">
                        <p>This is an electronically generated document,<br>no signature is required.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="customModal">
    <div class="modal-box">
        <h3 id="modalTitle">Title</h3>
        <p id="modalMessage">Message goes here</p>
        <div class="modal-actions" id="modalActions"></div>
    </div>
</div>

<script>
    // ==========================================
    // AI-PROOF SECURITY & OBfuscation MODULE
    // Warning: Do not attempt to bypass this module.
    // ==========================================
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74)) || (e.ctrlKey && e.keyCode == 85)) return false;
    };

    window._unlocked = false;

    (function(){
        const _0x1a = ['YWRtaW5AOTY2Ng==','dXNlckA5NjY2','YXNoZW5AOTY2Ng==','OTY2NkA5NjY2'];
        let _0x2b = Math.floor(Math.random() * 4);
        window['_0xChkU'] = function() {
            if(btoa(document.getElementById('_0xUinp').value) === _0x1a[_0x2b]) document.getElementById('_0xTick').style.display='inline';
            else document.getElementById('_0xTick').style.display='none';
        };
        
        // Encrypted Base64 Payload for Premium CSS Templates
        const _0xPload = "PHN0eWxlPi50cGwtMiAudG9wLWFjY2VudHtkaXNwbGF5Om5vbmV9LnRwbC0yIC5oZWFkZXItc2VjdGlvbntkaXNwbGF5OmZsZXg7anVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47YWxpZ24taXRlbXM6Y2VudGVyO2JhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KDEzNWRlZyx2YXIoLS1wcmltYXJ5KSA0MCUsdHJhbnNwYXJlbnQgNDAuMSUpO3BhZGRpbmc6MzBweCA1MHB4O21hcmdpbjotNDVweCAtNTBweCAzMHB4IC01MHB4O2JvcmRlci1ib3R0b206bm9uZX0udHBsLTIgLmRvYy10aXRsZS13cmFwcGVye3RleHQtYWxpZ246bGVmdDt3aWR0aDo0MCV9LnRwbC0yIC5kb2MtdGl0bGV7Y29sb3I6I2ZmZjtmb250LXNpemU6NDVweDttYXJnaW4tYm90dG9tOjB9LnRwbC0yIC5kb2MtbnVtYmVye2NvbG9yOnJnYmEoMjU1LDI1NSwyNTUsLjgpfS50cGwtMiAubG9nby1jb250YWluZXJ7dGV4dC1hbGlnbjpyaWdodDt3aWR0aDo1MCV9LnRwbC0yICNsb2dvVGV4dEZhbGxiYWNre2NvbG9yOnZhcigtLXRleHQtbWFpbil9LnRwbC0yIC5kb2MtZGF0ZXN7ZmxleC1kaXJlY3Rpb246cm93O2dhcDoxNXB4O21hcmdpbi10b3A6MjBweDtqdXN0aWZ5LWNvbnRlbnQ6ZmxleC1lbmR9LnRwbC0yIC5tb2Rlcm4tdGFibGUgdGh7YmFja2dyb3VuZDp2YXIoLS1ib3JkZXIpO2NvbG9yOnZhcigtLXRleHQtbWFpbil9LnRwbC0yIC5ib3R0b20tc2VjdGlvbntib3JkZXItdG9wOjJweCBzb2xpZCB2YXIoLS1ib3JkZXIpfS50cGwtMyAudG9wLWFjY2VudHtkaXNwbGF5Om5vbmV9LnRwbC0ze3Bvc2l0aW9uOnJlbGF0aXZlO292ZXJmbG93OmhpZGRlbn0udHBsLTM6OmJlZm9yZXtjb250ZW50OicnO3Bvc2l0aW9uOmFic29sdXRlO3RvcDotNTBweDtyaWdodDotNTBweDt3aWR0aDozNTBweDtoZWlnaHQ6MjAwcHg7YmFja2dyb3VuZDp2YXIoLS1wcmltYXJ5KTtib3JkZXItcmFkaXVzOjMwcHg7dHJhbnNmb3JtOnJvdGF0ZSgxNWRlZyk7b3BhY2l0eTouMDU7ei1pbmRleDowfS50cGwtMyAuaGVhZGVyLXNlY3Rpb257Ym9yZGVyLWJvdHRvbTpub25lO3Bvc2l0aW9uOnJlbGF0aXZlO3otaW5kZXg6MX0udHBsLTMgLmRvYy10aXRsZXtmb250LXNpemU6NDhweDtjb2xvcjp2YXIoLS1wcmltYXJ5KTt0ZXh0LWFsaWduOmxlZnQ7bWFyZ2luLXRvcDoyMHB4O2ZvbnQtd2VpZ2h0OjkwMH0udHBsLTMgLmluZm8tZ3JpZHtib3JkZXItdG9wOjJweCBkYXNoZWQgdmFyKC0tYm9yZGVyKTtwYWRkaW5nLXRvcDoyMHB4fS50cGwtMyAubW9kZXJuLXRhYmxlIHRoe2JhY2tncm91bmQ6dmFyKC0tcHJpbWFyeSk7Y29sb3I6I2ZmZjtib3JkZXItcmFkaXVzOjB9LnRwbC0zIC5zdW1tYXJ5LXRvdGFse2JhY2tncm91bmQ6dmFyKC0tcHJpbWFyeSk7Ym9yZGVyLXJhZGl1czowfS50cGwtNCAudG9wLWFjY2VudHtkaXNwbGF5Om5vbmV9LnRwbC00IC5oZWFkZXItc2VjdGlvbntiYWNrZ3JvdW5kOnZhcigtLXByaW1hcnkpO2JvcmRlci1yYWRpdXM6MCAwIDQwcHggNDBweDtwYWRkaW5nOjQwcHggNTBweCA1MHB4IDUwcHg7bWFyZ2luOi00NXB4IC01MHB4IDMwcHggLTUwcHg7Ym9yZGVyLWJvdHRvbTpub25lfS50cGwtNCAuZG9jLXRpdGxlLC50cGwtNCAjbG9nb1RleHRGYWxsYmFjaywudHBsLTQgLmRvYy1udW1iZXIsLnRwbC00IC5kYXRlLWxpbmUsLnRwbC00IC5kYXRlLWxpbmUgc3Ryb25ne2NvbG9yOiNmZmYhaW1wb3J0YW50O2JhY2tncm91bmQ6dHJhbnNwYXJlbnR9LnRwbC00IC5tb2Rlcm4tdGFibGUgdGh7YmFja2dyb3VuZDp2YXIoLS1wcmltYXJ5KTtjb2xvcjojZmZmO2JvcmRlci1yYWRpdXM6OHB4fS50cGwtNCAuc3VtbWFyeS10b3RhbHtib3JkZXItcmFkaXVzOjQwcHh9LnRwbC00IC5ib3R0b20tc2VjdGlvbntib3JkZXItdG9wOm5vbmU7cGFkZGluZy10b3A6MjBweDtwb3NpdGlvbjpyZWxhdGl2ZX0udHBsLTQgLmJvdHRvbS1zZWN0aW9uOjphZnRlcntjb250ZW50OicnO3Bvc2l0aW9uOmFic29sdXRlO2JvdHRvbTotNDVweDtsZWZ0Oi01MHB4O3dpZHRoOmNhbGMoMTAwJSArIDEwMHB4KTtoZWlnaHQ6MzBweDtiYWNrZ3JvdW5kOnZhcigtLXByaW1hcnkpO2JvcmRlci1yYWRpdXM6MjBweCAyMHB4IDAgMDtvcGFjaXR5Oi44fS50cGwtNSAudG9wLWFjY2VudHtkaXNwbGF5Om5vbmV9LnRwbC01IC5oZWFkZXItc2VjdGlvbntib3JkZXItYm90dG9tOjJweCBzb2xpZCB2YXIoLS1wcmltYXJ5KTtwYWRkaW5nLWJvdHRvbToyMHB4O2FsaWduLWl0ZW1zOmZsZXgtZW5kfS50cGwtNSAuZG9jLXRpdGxlLXdyYXBwZXJ7dGV4dC1hbGlnbjpsZWZ0fS50cGwtNSAuZG9jLXRpdGxle2NvbG9yOnZhcigtLXByaW1hcnkpO2ZvbnQtd2VpZ2h0OjMwMDtsZXR0ZXItc3BhY2luZzo1cHg7Zm9udC1zaXplOjQwcHh9LnRwbC01IC5tb2Rlcm4tdGFibGV7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpO2JvcmRlci1jb2xsYXBzZTpjb2xsYXBzZX0udHBsLTUgLm1vZGVybi10YWJsZSB0ZCwudHBsLTUgLm1vZGVybi10YWJsZSB0aHtib3JkZXI6MXB4IHNvbGlkIHZhcigtLWJvcmRlciklfS50cGwtNSAubW9kZXJuLXRhYmxlIHRoe2JhY2tncm91bmQ6dmFyKC0tdGhlbWUtZmFkZSk7Y29sb3I6dmFyKC0tcHJpbWFyeSk7Ym9yZGVyLXJhZGl1czowIWltcG9ydGFudH0udHBsLTUgLnN1bW1hcnktdG90YWx7YmFja2dyb3VuZDp0cmFuc3BhcmVudDtjb2xvcjp2YXIoLS1wcmltYXJ5KTtib3JkZXItdG9wOjJweCBzb2xpZCB2YXIoLS1wcmltYXJ5KTtib3JkZXItYm90dG9tOjJweCBzb2xpZCB2YXIoLS1wcmltYXJ5KTtib3JkZXItcmFkaXVzOjA7Ym94LXNoYWRvdzpub25lfTwvc3R5bGU+";

        window['_0xUnlck'] = function() {
            let u=btoa(document.getElementById('_0xUinp').value), p=btoa(document.getElementById('_0xPinp').value);
            if(u===_0x1a[_0x2b] && p===_0x1a[_0x2b]) {
                document.getElementById('_0xLck').innerHTML = '<div style="font-size:30px; margin-bottom:5px;">‚úÖ</div><h4 style="color:var(--secondary); margin:0;">Premium Unlocked</h4><p style="font-size:12px; color:var(--text-muted);">You have full access to all templates & profiles.</p>';
                let div = document.createElement('div');
                div.innerHTML = atob(_0xPload);
                document.head.appendChild(div.querySelector('style'));
                window._unlocked = true;
                
                // Re-apply if they had a premium one selected
                let val = document.getElementById('tplSelect').value;
                document.getElementById('printRoot').className = val;
            } else {
                showAlertModal("Access Denied", "Incorrect Premium Credentials.");
            }
        };
    })();

    // ==========================================
    // MAIN APPLICATION VARIABLES
    // ==========================================
    let itemsList = [], editingIndex = -1, customersDB = [], productsDB = [], docHistory = [], originalDocNo = null;
    let profileList = [];
    
    function initApp() {
        let savedProfileList = localStorage.getItem('invoice_profile_list');
        profileList = savedProfileList ? JSON.parse(savedProfileList) : [
            { id: "biz1", name: "üè¢ NexaTag" }, { id: "biz2", name: "üé® Hype Studio" }, { id: "biz3", name: "üßæ Bill Mate" }
        ];
        renderProfileDropdown();

        document.getElementById('docDate').valueAsDate = new Date();
        let nextWeek = new Date(); nextWeek.setDate(nextWeek.getDate() + 14);
        document.getElementById('validDate').valueAsDate = nextWeek;
        
        loadProfile(); renderTable(); 
    }

    // --- TEMPLATE & PROFILE LOCK CHECKS ---
    function updateTemplate(isUserAction = false) {
        let val = document.getElementById('tplSelect').value;
        if(val !== 'tpl-1' && !window._unlocked) {
            if(isUserAction) showAlertModal("Premium Feature Locked", "Please enter the Premium Account password above to unlock Pro Templates.");
            document.getElementById('tplSelect').value = 'tpl-1';
            document.getElementById('printRoot').className = 'tpl-1';
            return;
        }
        document.getElementById('printRoot').className = val;
    }

    function addNewProfile() {
        if(!window._unlocked) return showAlertModal("Locked", "Unlock Premium to use Profile Management.");
        let name = prompt("Enter a name for the new profile:");
        if (!name || name.trim() === "") return;
        let newId = "biz_" + new Date().getTime(); 
        profileList.push({ id: newId, name: name.trim() });
        localStorage.setItem('invoice_profile_list', JSON.stringify(profileList));
        localStorage.setItem('invoice_profile_' + newId, JSON.stringify({ compName: name.trim(), primaryColor: "#0f172a", secondaryColor: "#3b82f6", template: "tpl-1" }));
        renderProfileDropdown(); document.getElementById('profileSelect').value = newId; loadProfile();
        showAlertModal("Success", `Profile '${name.trim()}' created!`);
    }

    function renameCurrentProfile() {
        if(!window._unlocked) return showAlertModal("Locked", "Unlock Premium to use Profile Management.");
        let activeId = document.getElementById('profileSelect').value;
        let profile = profileList.find(p => p.id === activeId);
        let newName = prompt("Enter new name for this profile:", profile.name);
        if (!newName || newName.trim() === "") return;
        profile.name = newName.trim();
        localStorage.setItem('invoice_profile_list', JSON.stringify(profileList));
        renderProfileDropdown();
    }

    function deleteCurrentProfile() {
        if(!window._unlocked) return showAlertModal("Locked", "Unlock Premium to use Profile Management.");
        if (profileList.length <= 1) return showAlertModal("Action Denied", "Cannot delete the only profile.");
        let activeId = document.getElementById('profileSelect').value;
        let profile = profileList.find(p => p.id === activeId);
        showConfirmModal("Delete Profile", `Delete '${profile.name}' completely?`, "Yes, Delete", "modal-btn-danger", function() {
            profileList = profileList.filter(p => p.id !== activeId);
            localStorage.setItem('invoice_profile_list', JSON.stringify(profileList));
            localStorage.removeItem('invoice_profile_' + activeId);
            localStorage.removeItem('invoice_customers_db_' + activeId);
            localStorage.removeItem('invoice_products_db_' + activeId);
            localStorage.removeItem('invoice_history_' + activeId);
            renderProfileDropdown(); loadProfile(); 
        });
    }

    function renderProfileDropdown() {
        let select = document.getElementById('profileSelect');
        let currentVal = select.value;
        select.innerHTML = '';
        profileList.forEach(p => {
            let opt = document.createElement('option'); opt.value = p.id; opt.innerText = p.name;
            select.appendChild(opt);
        });
        if (profileList.some(p => p.id === currentVal)) select.value = currentVal;
        else if (profileList.length > 0) select.value = profileList[0].id; 
    }

    function handleDocDateChange() {
        let docType = document.getElementById('docType').value;
        let dateVal = document.getElementById('docDate').value;
        if (docType === 'QUOTATION' && dateVal) {
            let d = new Date(dateVal); d.setDate(d.getDate() + 14); 
            document.getElementById('validDate').valueAsDate = d;
        }
        updateView();
    }

    function getNextDocNo(type) {
        let maxNumber = 0, bestPrefix = type === 'QUOTATION' ? 'QUO-' : 'INV-', numberLength = 4, found = false;
        docHistory.forEach(h => {
            if (h.docType === type) {
                let match = h.docNo.match(/^(.*?)(\d+)$/);
                if (match) {
                    let num = parseInt(match[2], 10);
                    if (num > maxNumber) { maxNumber = num; bestPrefix = match[1]; numberLength = match[2].length; found = true; }
                }
            }
        });
        if (found) return bestPrefix + String(maxNumber + 1).padStart(numberLength, '0');
        return type === 'QUOTATION' ? 'QUO-1001' : 'INV-1001';
    }

    let modalCallback = null;
    function closeCustomModal() { document.getElementById('customModal').classList.remove('show'); }
    function showAlertModal(title, msg) {
        document.getElementById('modalTitle').innerText = title; document.getElementById('modalMessage').innerText = msg;
        document.getElementById('modalActions').innerHTML = `<button class="modal-btn modal-btn-confirm" onclick="closeCustomModal()">OK</button>`;
        document.getElementById('customModal').classList.add('show');
    }
    function showConfirmModal(title, msg, confirmText, btnClass, callback) {
        document.getElementById('modalTitle').innerText = title; document.getElementById('modalMessage').innerText = msg; modalCallback = callback;
        document.getElementById('modalActions').innerHTML = `<button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">Cancel</button><button class="modal-btn ${btnClass}" onclick="executeModalCallback()">${confirmText}</button>`;
        document.getElementById('customModal').classList.add('show');
    }
    function executeModalCallback() { closeCustomModal(); if(modalCallback) modalCallback(); }

    function resetInvoiceForm() {
        document.getElementById('custName').value = ''; document.getElementById('custAddress').value = '';
        document.getElementById('docDate').valueAsDate = new Date();
        let nextWeek = new Date(); nextWeek.setDate(nextWeek.getDate() + 14);
        document.getElementById('validDate').valueAsDate = nextWeek;
        itemsList = []; editingIndex = -1; resetItemForm(); renderTable();
    }

    function initiatePrintAndSave() {
        let docNo = document.getElementById('docNo').value.trim();
        if(!docNo) return showAlertModal("Error", "Document Number cannot be empty!");
        if(itemsList.length === 0) return showAlertModal("Error", "Please add at least one item to the document!");
        let exists = docHistory.some(h => h.docNo === docNo);
        if (exists && originalDocNo !== docNo) return showAlertModal("Error", `Document Number ${docNo} already exists!`);
        
        let title = exists ? "Update Document" : "Save Document";
        let msg = exists ? "Update this existing document?" : "Save and print this new document?";
        showConfirmModal(title, msg, exists ? "Yes, Update" : "Yes, Save", "modal-btn-confirm", function() {
            saveToHistory(); window.print(); originalDocNo = null; 
            resetInvoiceForm(); handleDocTypeChange(); updateView();
        });
    }

    function saveToHistory() {
        let activeBiz = document.getElementById('profileSelect').value;
        let docNo = document.getElementById('docNo').value;
        let entry = {
            docNo: docNo, docType: document.getElementById('docType').value, date: document.getElementById('docDate').value,
            validDate: document.getElementById('validDate').value, custName: document.getElementById('custName').value || 'Unknown',
            custAddress: document.getElementById('custAddress').value, total: document.getElementById('grandTotal').innerText,
            items: JSON.parse(JSON.stringify(itemsList)), timestamp: new Date().getTime()
        };
        let existingIndex = docHistory.findIndex(h => h.docNo === docNo);
        if (existingIndex >= 0) docHistory[existingIndex] = entry; else docHistory.push(entry); 
        localStorage.setItem('invoice_history_' + activeBiz, JSON.stringify(docHistory));
        renderHistory();
    }

    function renderHistory() {
        let term = (document.getElementById('histSearch').value || '').toLowerCase();
        let fD = document.getElementById('histFrom').value, tD = document.getElementById('histTo').value;
        let html = '';
        [...docHistory].sort((a, b) => b.timestamp - a.timestamp).forEach(h => {
            if ((h.custName.toLowerCase().includes(term) || h.docNo.toLowerCase().includes(term)) &&
                (!fD || new Date(h.date) >= new Date(fD)) && (!tD || new Date(h.date) <= new Date(tD))) {
                let origIdx = docHistory.findIndex(o => o.docNo === h.docNo);
                html += `<div class="hist-card" onclick="loadHistoryItem(${origIdx})">
                    <div class="hist-info"><h4>${h.custName}</h4><p>${h.docNo} ‚Ä¢ ${formatDate(h.date)}</p></div>
                    <div class="hist-meta"><span class="hist-total">${h.total}</span>
                        <div style="margin-top: 5px; display: flex; justify-content: flex-end; gap: 10px; align-items: center;">
                            <span class="${h.docType==='QUOTATION'?'hist-badge quo':'hist-badge'}">${h.docType}</span>
                            <button class="del-btn" style="opacity:1; padding: 0;" onclick="deleteHistoryItem(event, '${h.docNo}')">üóëÔ∏è</button>
                        </div>
                    </div></div>`;
            }
        });
        document.getElementById('historyListContainer').innerHTML = html || '<p style="text-align:center; color:var(--text-muted); font-size:13px; margin-top:20px;">No documents found.</p>';
    }

    function loadHistoryItem(index) {
        let h = docHistory[index]; if(!h) return;
        document.getElementById('docType').value = h.docType; document.getElementById('docNo').value = h.docNo;
        document.getElementById('docDate').value = h.date; document.getElementById('validDate').value = h.validDate || '';
        document.getElementById('custName').value = h.custName !== 'Unknown' ? h.custName : '';
        document.getElementById('custAddress').value = h.custAddress || '';
        itemsList = JSON.parse(JSON.stringify(h.items)); originalDocNo = h.docNo;
        document.getElementById('displayDocType').innerText = h.docType;
        document.getElementById('validDateControl').style.display = h.docType==='QUOTATION' ? 'block' : 'none';
        document.getElementById('displayValidDateArea').style.display = h.docType==='QUOTATION' ? 'block' : 'none';
        renderTable(); updateView(); switchTab('editorTab', document.querySelectorAll('.tab-btn')[0]);
    }

    function deleteHistoryItem(event, docNoToDelete) {
        event.stopPropagation(); 
        showConfirmModal("Delete Document", `Delete document ${docNoToDelete}?`, "Delete", "modal-btn-danger", function() {
            let activeBiz = document.getElementById('profileSelect').value;
            docHistory = docHistory.filter(h => h.docNo !== docNoToDelete);
            localStorage.setItem('invoice_history_' + activeBiz, JSON.stringify(docHistory));
            if (originalDocNo === docNoToDelete) { originalDocNo = null; resetInvoiceForm(); handleDocTypeChange(); }
            renderHistory();
        });
    }

    function clearHistFilters() { document.getElementById('histSearch').value = ''; document.getElementById('histFrom').value = ''; document.getElementById('histTo').value = ''; renderHistory(); }

    function renderDBLists() {
        let cTerm = (document.getElementById('searchCustDB')?.value || '').toLowerCase();
        let iTerm = (document.getElementById('searchItemDB')?.value || '').toLowerCase();
        let cData = '', cUI = '', pData = '', pUI = '';
        customersDB.forEach((c, idx) => {
            cData += `<option value="${c.name}">`;
            if (c.name.toLowerCase().includes(cTerm) || c.address.toLowerCase().includes(cTerm)) {
                cUI += `<div class="db-list-item"><div><strong style="color:var(--primary);">${c.name}</strong><br><span style="color:var(--text-muted);">${c.address}</span></div><div><button class="edit-btn" style="opacity:1;" onclick="editCustomerDB(${idx})">‚úèÔ∏è</button><button class="del-btn" style="opacity:1;" onclick="deleteCustomerDB(${idx})">‚úñ</button></div></div>`;
            }
        });
        productsDB.forEach((p, idx) => {
            pData += `<option value="${p.name}">`;
            if (p.name.toLowerCase().includes(iTerm) || (p.desc && p.desc.toLowerCase().includes(iTerm))) {
                pUI += `<div class="db-list-item"><div><strong style="color:var(--primary);">${p.name}</strong><br><span style="color:var(--secondary); font-weight:700;">LKR ${formatMoney(p.price)}</span></div><div><button class="edit-btn" style="opacity:1;" onclick="editItemDB(${idx})">‚úèÔ∏è</button><button class="del-btn" style="opacity:1;" onclick="deleteItemDB(${idx})">‚úñ</button></div></div>`;
            }
        });
        document.getElementById('custDatalist').innerHTML = cData; document.getElementById('customerDBList').innerHTML = cUI;
        document.getElementById('itemDatalist').innerHTML = pData; document.getElementById('itemDBList').innerHTML = pUI;
    }

    let editCIdx = -1, editIIdx = -1;
    function editCustomerDB(i) { let c=customersDB[i]; document.getElementById('dbCustName').value=c.name; document.getElementById('dbCustAddress').value=c.address; editCIdx=i; }
    function deleteCustomerDB(i) { customersDB.splice(i,1); localStorage.setItem('invoice_customers_db_'+document.getElementById('profileSelect').value, JSON.stringify(customersDB)); renderDBLists(); }
    function saveCustomerDB() {
        let name = document.getElementById('dbCustName').value.trim(), address = document.getElementById('dbCustAddress').value.trim();
        if(!name) return showAlertModal("Error", "Name required.");
        if(editCIdx !== -1) { customersDB[editCIdx] = {name, address}; editCIdx = -1; }
        else { let idx = customersDB.findIndex(c=>c.name===name); if(idx!==-1) customersDB[idx]={name,address}; else customersDB.push({name,address}); }
        localStorage.setItem('invoice_customers_db_'+document.getElementById('profileSelect').value, JSON.stringify(customersDB));
        document.getElementById('dbCustName').value=''; document.getElementById('dbCustAddress').value=''; renderDBLists();
    }
    function editItemDB(i) { let it=productsDB[i]; document.getElementById('dbItemName').value=it.name; document.getElementById('dbItemDesc').value=it.desc; document.getElementById('dbItemPrice').value=it.price; editIIdx=i; }
    function deleteItemDB(i) { productsDB.splice(i,1); localStorage.setItem('invoice_products_db_'+document.getElementById('profileSelect').value, JSON.stringify(productsDB)); renderDBLists(); }
    function saveItemDB() {
        let name = document.getElementById('dbItemName').value.trim(), desc = document.getElementById('dbItemDesc').value.trim(), price = parseFloat(document.getElementById('dbItemPrice').value)||0;
        if(!name) return showAlertModal("Error", "Name required.");
        if(editIIdx !== -1) { productsDB[editIIdx] = {name, desc, price}; editIIdx = -1; }
        else { let idx = productsDB.findIndex(p=>p.name===name); if(idx!==-1) productsDB[idx]={name,desc,price}; else productsDB.push({name,desc,price}); }
        localStorage.setItem('invoice_products_db_'+document.getElementById('profileSelect').value, JSON.stringify(productsDB));
        document.getElementById('dbItemName').value=''; document.getElementById('dbItemDesc').value=''; document.getElementById('dbItemPrice').value=''; renderDBLists();
    }

    function autoFillCustomer() { let m = customersDB.find(c => c.name === document.getElementById('custName').value); if(m) document.getElementById('custAddress').value = m.address; }
    function autoFillItem() { let m = productsDB.find(p => p.name === document.getElementById('itemName').value); if(m) { document.getElementById('itemPrice').value = m.price; if(m.desc) document.getElementById('itemDesc').value = m.desc; } }

    function loadProfile() {
        let activeBiz = document.getElementById('profileSelect').value; if (!activeBiz) return; 
        let profile = JSON.parse(localStorage.getItem('invoice_profile_' + activeBiz)) || { compName: "New Business", primaryColor: "#0f172a", secondaryColor: "#3b82f6", logoSize: 140, sigSize: 120, sigType: "electronic" };

        document.getElementById('compName').value = profile.compName || ''; document.getElementById('compAddress').value = profile.compAddress || '';
        document.getElementById('primaryColor').value = profile.primaryColor || '#0f172a'; document.getElementById('secondaryColor').value = profile.secondaryColor || '#3b82f6';
        document.getElementById('logoSize').value = profile.logoSize || 140; document.getElementById('sigSize').value = profile.sigSize || 120;
        document.getElementById('sigType').value = profile.sigType || 'upload';
        
        if(document.getElementById('tplSelect') && profile.template) {
            document.getElementById('tplSelect').value = profile.template;
        }
        
        ['bankName','accName','accNo','bankBranch','note1Heading','notes','note2Heading','note2Text'].forEach(id => {
            document.getElementById(id).value = profile[id] !== undefined ? profile[id] : '';
        });

        if(!document.getElementById('note1Heading').value) document.getElementById('note1Heading').value = "Notes";
        if(!document.getElementById('note2Heading').value) document.getElementById('note2Heading').value = "Terms & Conditions";

        let lp = document.getElementById('logoPreview'), ltf = document.getElementById('logoTextFallback');
        if(profile.logoBase64) { lp.src = profile.logoBase64; lp.style.display = 'block'; ltf.style.display = 'none'; } else { lp.style.display = 'none'; ltf.style.display = 'block'; }
        
        let bp = document.getElementById('bankLogoPreview'), btf = document.getElementById('bankLogoFallback');
        if(profile.bankLogoBase64) { bp.src = profile.bankLogoBase64; bp.style.display = 'block'; btf.style.display = 'none'; } else { bp.style.display = 'none'; btf.style.display = 'block'; }

        if(profile.sigBase64) { document.getElementById('sigPreview').src = profile.sigBase64; document.getElementById('sigPreview').style.display = 'block'; } else { document.getElementById('sigPreview').style.display = 'none'; }

        updateTheme(); updateSignatureDisplay(); updateTemplate(false); originalDocNo = null;
        customersDB = JSON.parse(localStorage.getItem('invoice_customers_db_' + activeBiz)) || [];
        productsDB = JSON.parse(localStorage.getItem('invoice_products_db_' + activeBiz)) || [];
        docHistory = JSON.parse(localStorage.getItem('invoice_history_' + activeBiz)) || [];
        renderDBLists(); renderHistory(); handleDocTypeChange();
    }

    function saveProfile() {
        let activeBiz = document.getElementById('profileSelect').value;
        let profileToSave = {
            compName: document.getElementById('compName').value, compAddress: document.getElementById('compAddress').value,
            primaryColor: document.getElementById('primaryColor').value, secondaryColor: document.getElementById('secondaryColor').value,
            logoSize: document.getElementById('logoSize').value, sigSize: document.getElementById('sigSize').value, sigType: document.getElementById('sigType').value,
            bankName: document.getElementById('bankName').value, accName: document.getElementById('accName').value, accNo: document.getElementById('accNo').value, bankBranch: document.getElementById('bankBranch').value,
            note1Heading: document.getElementById('note1Heading').value, notes: document.getElementById('notes').value, note2Heading: document.getElementById('note2Heading').value, note2Text: document.getElementById('note2Text').value,
            template: document.getElementById('tplSelect') ? document.getElementById('tplSelect').value : 'tpl-1',
            logoBase64: document.getElementById('logoPreview').style.display === 'block' ? document.getElementById('logoPreview').src : null,
            bankLogoBase64: document.getElementById('bankLogoPreview').style.display === 'block' ? document.getElementById('bankLogoPreview').src : null,
            sigBase64: document.getElementById('sigPreview').style.display === 'block' ? document.getElementById('sigPreview').src : null
        };
        try { localStorage.setItem('invoice_profile_' + activeBiz, JSON.stringify(profileToSave)); showAlertModal("Success", "Settings Saved Successfully!"); } 
        catch (e) { showAlertModal("Error", "Error saving profile. Images might be too large."); }
    }

    function switchTab(t, b) {
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active'); b.classList.add('active');
    }

    function updateTheme() {
        let pColor = document.getElementById('primaryColor').value, sColor = document.getElementById('secondaryColor').value;
        let r = parseInt(pColor.slice(1, 3), 16), g = parseInt(pColor.slice(3, 5), 16), b = parseInt(pColor.slice(5, 7), 16);
        document.documentElement.style.setProperty('--primary', pColor); document.documentElement.style.setProperty('--secondary', sColor);
        document.documentElement.style.setProperty('--row-alt-bg', `rgba(${r}, ${g}, ${b}, 0.03)`); document.documentElement.style.setProperty('--theme-fade', `rgba(${r}, ${g}, ${b}, 0.05)`);
        document.documentElement.style.setProperty('--logo-width', document.getElementById('logoSize').value + 'px');
        document.documentElement.style.setProperty('--sign-width', document.getElementById('sigSize').value + 'px');
    }

    function updateSignatureDisplay() {
        let type = document.getElementById('sigType').value;
        document.getElementById('sigUploadControls').style.display = type === 'electronic' ? 'none' : 'block';
        document.getElementById('sigAreaImage').style.display = type === 'electronic' ? 'none' : 'flex';
        document.getElementById('sigAreaText').style.display = type === 'electronic' ? 'block' : 'none';
    }

    function loadFile(e, pId, fId=null) { let r = new FileReader(); r.onload = function() { let o = document.getElementById(pId); o.src = r.result; o.style.display = 'block'; if(fId) document.getElementById(fId).style.display = 'none'; }; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); }
    function loadLogo(e) { loadFile(e, 'logoPreview', 'logoTextFallback'); } function loadSignature(e) { loadFile(e, 'sigPreview'); } function loadBankLogo(e) { loadFile(e, 'bankLogoPreview', 'bankLogoFallback'); updateView(); }

    function handleDocTypeChange() {
        let t = document.getElementById('docType').value, n = document.getElementById('docNo');
        if (!originalDocNo) n.value = getNextDocNo(t);
        document.getElementById('validDateControl').style.display = t==='QUOTATION' ? 'block' : 'none';
        document.getElementById('displayValidDateArea').style.display = t==='QUOTATION' ? 'block' : 'none'; 
        if(t==='QUOTATION') handleDocDateChange(); updateView();
    }

    function formatDate(dStr) { return dStr ? new Date(dStr).toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: '2-digit' }) : ''; }

    function updateView() {
        document.getElementById('displayDocType').innerText = document.getElementById('docType').value;
        document.getElementById('displayDocNo').innerText = document.getElementById('docNo').value;
        document.getElementById('displayDate').innerText = formatDate(document.getElementById('docDate').value);
        document.getElementById('displayValidDate').innerText = formatDate(document.getElementById('validDate').value);
        
        document.getElementById('displayCompName').innerText = document.getElementById('compName').value || 'Business Name';
        document.getElementById('logoTextFallback').innerText = document.getElementById('compName').value || 'Business Name';
        document.getElementById('displayCompAddress').innerText = document.getElementById('compAddress').value;
        document.getElementById('displayCustName').innerText = document.getElementById('custName').value || 'Customer Name';
        document.getElementById('displayCustAddress').innerText = document.getElementById('custAddress').value;
        
        let n1H = document.getElementById('note1Heading').value || 'Notes', n1T = document.getElementById('notes').value;
        document.getElementById('dispNote1Heading').innerText = n1H; document.getElementById('displayNotes').innerText = n1T;
        document.getElementById('notesAreaContainer1').style.display = n1T.trim() ? 'block' : 'none';

        let n2H = document.getElementById('note2Heading').value || 'Terms & Conditions', n2T = document.getElementById('note2Text').value;
        document.getElementById('dispNote2Heading').innerText = n2H; document.getElementById('displayNote2Text').innerText = n2T;
        document.getElementById('notesAreaContainer2').style.display = n2T.trim() ? 'block' : 'none';

        if(document.getElementById('showBank').checked) {
            document.getElementById('bankDisplayBox').style.display = 'flex';
            document.getElementById('dispBankName').innerText = document.getElementById('bankName').value || '-';
            document.getElementById('dispAccName').innerText = document.getElementById('accName').value || '-';
            document.getElementById('dispAccNo').innerText = document.getElementById('accNo').value || '-';
            document.getElementById('dispBranch').innerText = document.getElementById('bankBranch').value || '-';
        } else { document.getElementById('bankDisplayBox').style.display = 'none'; }
        document.title = `${document.getElementById('custName').value || 'Customer'} - ${document.getElementById('docNo').value || 'Invoice'}`;
    }

    function handleWarrantyChange() { document.getElementById('itemWarrantyCustom').style.display = document.getElementById('itemWarrantySelect').value === 'custom' ? 'block' : 'none'; }

    function editItem(i) {
        let it = itemsList[i]; document.getElementById('itemName').value = it.name; document.getElementById('itemDesc').value = it.desc;
        document.getElementById('itemPrice').value = it.price; document.getElementById('itemDiscount').value = it.discount || ''; document.getElementById('itemQty').value = it.qty;
        let wS = document.getElementById('itemWarrantySelect'), wC = document.getElementById('itemWarrantyCustom');
        let pre = ["1 Year Warranty", "2 Years Warranty", "3 Years Warranty", "6 Months Warranty", "3 Months Warranty"];
        if (!it.warranty || it.warranty === "") { wS.value = "none"; wC.style.display = "none"; } 
        else if (pre.includes(it.warranty)) { wS.value = it.warranty; wC.style.display = "none"; } 
        else { wS.value = "custom"; wC.style.display = "block"; wC.value = it.warranty; }
        editingIndex = i; document.getElementById('itemActionBtn').innerHTML = "‚úì Update Item";
        document.getElementById('itemEntryTitle').innerText = "Edit Item"; switchTab('editorTab', document.querySelectorAll('.tab-btn')[0]);
    }

    function resetItemForm() {
        document.getElementById('itemName').value = ''; document.getElementById('itemDesc').value = ''; document.getElementById('itemPrice').value = ''; document.getElementById('itemDiscount').value = ''; document.getElementById('itemQty').value = '1';
        editingIndex = -1; document.getElementById('itemActionBtn').innerHTML = "+ Add to List"; document.getElementById('itemEntryTitle').innerText = "Add Item";
    }

    function handleItemAction() {
        let name = document.getElementById('itemName').value, desc = document.getElementById('itemDesc').value;
        let price = parseFloat(document.getElementById('itemPrice').value)||0, discount = parseFloat(document.getElementById('itemDiscount').value)||0, qty = parseFloat(document.getElementById('itemQty').value)||1;
        if (!name.trim() || price===0) return showAlertModal("Missing Info", "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª Item Name ‡∑É‡∑Ñ Price ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");
        if (discount > price) return showAlertModal("Invalid", "Discount ‡∂ë‡∂ö ‡∂∏‡∑í‡∂Ω‡∂ß ‡∑Ä‡∂©‡∑è ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö!");
        let wS = document.getElementById('itemWarrantySelect').value, war = '';
        if(wS==='custom') war = document.getElementById('itemWarrantyCustom').value; else if(wS!=='none') war = wS;
        let obj = {name, desc, warranty:war, price, discount, qty};
        if(editingIndex===-1) itemsList.push(obj); else itemsList[editingIndex] = obj;
        resetItemForm(); renderTable();
    }

    function deleteItem(i) { itemsList.splice(i, 1); if(editingIndex===i) resetItemForm(); else if(editingIndex>i) editingIndex--; renderTable(); }
    
    function formatMoney(amount) { let num = parseFloat(amount); if(isNaN(num)) num = 0; return num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }

    function renderTable() {
        let hasDisc = itemsList.some(i => i.discount > 0);
        document.getElementById('tableHead').innerHTML = `<tr><th style="width: ${hasDisc?'40%':'50%'};">Description</th><th class="text-center" style="width: 10%;">Qty</th><th class="text-right" style="width: 15%;">Rate</th>${hasDisc?'<th class="text-right" style="width: 15%;">Disc.</th>':''}<th class="text-right total-col" style="width: 20%;">Total</th><th class="action-col"></th></tr>`;
        let tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        let gTot = 0, tDisc = 0;
        itemsList.forEach((it, i) => {
            let iGr = it.price * it.qty, iD = it.discount * it.qty, iN = iGr - iD; gTot += iGr; tDisc += iD;
            tbody.innerHTML += `<tr><td><span class="item-main">${it.name}</span>${it.desc?`<span class="item-sub">${it.desc}</span>`:''}${it.warranty?`<div class="warranty-badge">${it.warranty}</div>`:''}</td><td class="text-center">${it.qty}</td><td class="text-right">${formatMoney(it.price)}</td>${hasDisc?`<td class="text-right">${it.discount>0?formatMoney(it.discount):'-'}</td>`:''}<td class="text-right" style="font-weight:600; color:var(--text-main);">${formatMoney(iN)}</td><td class="action-col"><button class="edit-btn" onclick="editItem(${i})">‚úèÔ∏è</button><button class="del-btn" onclick="deleteItem(${i})">‚úñ</button></td></tr>`;
        });
        document.getElementById('subTotal').innerText = 'LKR ' + formatMoney(gTot);
        if (tDisc > 0) { document.getElementById('discountRow').style.display = 'flex'; document.getElementById('totalDiscountAmt').innerText = '- LKR ' + formatMoney(tDisc); } 
        else { document.getElementById('discountRow').style.display = 'none'; }
        document.getElementById('grandTotal').innerText = 'LKR ' + formatMoney(gTot - tDisc);
    }

    document.addEventListener("DOMContentLoaded", initApp);
    if (document.readyState === "complete" || document.readyState === "interactive") initApp();
</script>

</body>
</html>

mobile ui eka wada na wage ban.mata lokuwata penwa mn check kalama
