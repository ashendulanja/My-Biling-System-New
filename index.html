<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Business Pro Invoice</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0f172a;       
            --secondary: #3b82f6;     
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --bg-body: #f1f5f9;
            --white: #ffffff;
            --logo-width: 140px;
            --sign-width: 120px;
            --row-alt-bg: rgba(15, 23, 42, 0.03); 
            --theme-fade: rgba(15, 23, 42, 0.05);
        }

        body { font-family: 'Plus Jakarta Sans', system-ui, sans-serif; background: var(--bg-body); margin: 0; padding: 20px; color: var(--text-main); }
        .app-container { display: flex; gap: 30px; max-width: 1600px; margin: auto; align-items: flex-start; }
        
        .controls { flex: 1.1; background: var(--white); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); position: sticky; top: 20px; max-height: 95vh; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border);}
        
        .profile-header { background: #f8fafc; padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 15px;}
        .profile-header select { flex: 1; padding: 10px; font-weight: 700; border-radius: 8px; border: 2px solid var(--primary); color: var(--primary); font-size: 14px; cursor: pointer;}
        .btn-save-profile { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s;}
        .btn-save-profile:hover { opacity: 0.9; }

        .tabs { display: flex; background: var(--white); border-bottom: 1px solid var(--border); flex-wrap: wrap;}
        .tab-btn { flex: 1; padding: 14px 10px; text-align: center; font-weight: 700; color: var(--text-muted); cursor: pointer; border: none; background: transparent; transition: all 0.2s; font-size: 13px; font-family: inherit; white-space: nowrap;}
        .tab-btn.active { color: var(--primary); box-shadow: inset 0 -3px 0 var(--primary); }
        .tab-btn:hover:not(.active) { background: #f1f5f9; }

        .tab-content { padding: 25px; overflow-y: auto; flex: 1; display: none; }
        .tab-content.active { display: block; }
        .tab-content::-webkit-scrollbar { width: 5px; }
        .tab-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .control-group { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .control-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .control-group h3 { margin-top: 0; color: var(--primary); font-size: 13px; margin-bottom: 15px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;}
        
        label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
        input[type="text"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 10px 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 13px; color: var(--text-main); transition: all 0.2s; background: #f8fafc;}
        input:focus, select:focus, textarea:focus { border-color: var(--secondary); outline: none; background: var(--white); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        textarea { resize: vertical; height: 60px; }
        
        .color-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .color-box { flex: 1; }
        input[type="color"] { width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer; padding: 0; background: none;}
        input[type="range"] { width: 100%; margin-bottom: 15px; cursor: pointer; accent-color: var(--primary); }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #eff6ff; padding: 12px; border-radius: 8px; border: 1px solid #bfdbfe;}
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: var(--secondary); }
        .checkbox-wrapper label { margin: 0; font-size: 14px; color: var(--primary); cursor: pointer; }

        .btn { background: var(--primary); color: var(--white); border: none; padding: 14px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.2s; font-family: inherit;}
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-add { background: var(--white); color: var(--primary); border: 1px solid var(--primary); }
        .btn-add:hover { background: var(--primary); color: white; }
        .btn-print { margin: 20px 25px 25px 25px; width: calc(100% - 50px); background: #10b981; }
        .btn-print:hover { background: #059669; }

        .item-entry-box { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); transition: all 0.3s;}

        .preview { flex: 1.5; background: var(--white); border-radius: 0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); min-height: 1123px; width: 794px; box-sizing: border-box; position: relative; display: flex; flex-direction: column; overflow: visible;}
        
        .top-accent { height: 6px; width: 100%; background: var(--primary); }
        
        .preview-content { padding: 35px 40px; flex: 1; display: flex; flex-direction: column; }

        .header-section { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; } 
        .logo-container img { width: var(--logo-width); max-height: 80px; object-fit: contain; }
        
        .doc-title-wrapper { text-align: right; }
        .doc-title { font-size: 32px; color: var(--primary); margin: 0 0 5px 0; font-weight: 800; letter-spacing: -0.5px; text-transform: uppercase;}
        .doc-number { font-size: 15px; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; margin-bottom: 10px;}
        
        .doc-dates { display: flex; flex-direction: column; gap: 3px; align-items: flex-end; }
        .date-line { font-size: 13px; color: var(--text-main); }
        .date-line strong { color: var(--text-muted); font-weight: 600; display: inline-block; width: 85px; text-align: right; margin-right: 10px;}

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-card { background: var(--theme-fade); padding: 15px 20px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.03); }
        .info-card h4 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 0 0 6px 0; font-weight: 700; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 6px;}
        .info-title { font-size: 15px; font-weight: 800; color: var(--primary); margin: 0 0 5px 0; }
        .info-text { font-size: 13px; color: var(--text-main); line-height: 1.5; white-space: pre-line; }

        /* TABLE */
        .modern-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .modern-table th { background: var(--primary); color: var(--white); padding: 10px 12px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .modern-table th:first-child { border-top-left-radius: 6px; border-bottom-left-radius: 6px;}
        .modern-table th.total-col { border-top-right-radius: 6px; border-bottom-right-radius: 6px; } 
        .modern-table th.action-col { background: transparent; border: none; width: 55px; padding: 0;}
        
        .modern-table td { padding: 10px 12px; vertical-align: top; border-bottom: 1px solid var(--border); font-size: 13px; background-color: var(--white); }
        .modern-table tbody tr:nth-child(even) td { background-color: var(--row-alt-bg); }
        
        .text-right { text-align: right !important; }
        .text-center { text-align: center !important; }
        
        .item-main { font-weight: 700; display: block; margin-bottom: 3px; color: var(--primary); font-size: 13px;}
        .item-sub { font-size: 12px; color: var(--text-muted); white-space: pre-line; display: block;}
        .warranty-badge { display: inline-block; color: var(--text-muted); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-top: 4px; border: 1px solid var(--border); background: var(--white);}

        .summary-section { display: flex; justify-content: flex-end; margin-top: 5px; margin-bottom: 15px;}
        .summary-box { width: 300px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: var(--text-main); padding: 0 16px;}
        .summary-row.discount-row { color: #ef4444; font-weight: 600; }
        
        .summary-total { display: flex; justify-content: space-between; margin-top: 10px; padding: 12px 16px; background: #f8fafc; border-left: 4px solid var(--secondary); border-radius: 0 8px 8px 0; font-size: 16px; font-weight: 800; color: var(--primary); }

        .bank-details-box { display: flex; align-items: center; gap: 15px; background: var(--white); border: 1px solid var(--border); border-radius: 10px; padding: 12px 15px; margin-bottom: 15px; width: max-content; min-width: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);}
        .bank-logo-area { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 6px; border: 1px solid var(--border); overflow: hidden; flex-shrink: 0;}
        .bank-logo-area img { max-width: 100%; max-height: 100%; object-fit: contain; padding: 2px;}
        .bank-logo-area i { font-size: 20px; color: var(--text-muted); font-style: normal;}
        .bank-info-area { flex: 1; }
        .bank-info-area h4 { margin: 0 0 4px 0; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
        .bank-info-line { font-size: 11px; color: var(--text-main); margin-bottom: 2px; display: flex; justify-content: space-between; gap: 15px;}
        .bank-info-line strong { font-weight: 600; color: var(--primary); text-align: right;}

        .bottom-section { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; padding-top: 15px; }
        .notes-area { flex: 1; padding-right: 40px; }
        .notes-area h4 { margin: 0 0 6px 0; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;}
        .notes-area p { margin: 0; font-size: 11px; color: var(--text-main); font-weight: 500; white-space: pre-line; line-height: 1.5;}
        
        .signature-area { text-align: center; width: 150px; }
        .sig-image-container { height: 60px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 5px; }
        .sig-image-container img { width: var(--sign-width); max-height: 60px; object-fit: contain; }
        .sig-line { border-top: 1px solid var(--border); padding-top: 6px; font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;}

        .electronic-sig-text { text-align: right; max-width: 250px; }
        .electronic-sig-text p { font-size: 10px; color: var(--text-muted); font-style: italic; margin: 0; line-height: 1.5; }

        /* ACTION BUTTONS */
        .del-btn, .edit-btn { background: transparent; border: none; padding: 6px; font-size: 14px; cursor: pointer; transition: 0.2s; opacity: 0;}
        .del-btn { color: #ef4444; }
        .edit-btn { color: var(--secondary); }
        tr:hover .del-btn, tr:hover .edit-btn { opacity: 1; }
        .del-btn:hover, .edit-btn:hover { transform: scale(1.15); }
        .action-col { width: 55px; padding: 0 !important; vertical-align: middle !important; text-align: center; background: transparent !important; white-space: nowrap;}

        /* DB & HISTORY UI */
        .db-list-item { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f8fafc; border:1px solid var(--border); margin-bottom:8px; border-radius:8px;}
        .search-bar { border: 1px solid var(--secondary) !important; background: var(--white) !important; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}

        .hist-card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 12px; transition: all 0.2s; cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
        .hist-card:hover { border-color: var(--secondary); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transform: translateY(-2px); }
        .hist-info h4 { margin: 0 0 5px 0; color: var(--primary); font-size: 15px; font-weight: 800;}
        .hist-info p { margin: 0; font-size: 12px; color: var(--text-muted); font-weight: 600;}
        .hist-meta { text-align: right; }
        .hist-meta .hist-total { font-size: 15px; font-weight: 800; color: var(--primary); margin-bottom: 5px; display: block;}
        .hist-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; background: #e0f2fe; color: #0284c7;}
        .hist-badge.quo { background: #fef3c7; color: #d97706; }

        /* CUSTOM MODAL CSS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px);}
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; padding: 25px; border-radius: 16px; width: 350px; max-width: 90%; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.show .modal-box { transform: translateY(0); }
        .modal-box h3 { margin-top: 0; color: var(--primary); margin-bottom: 10px; font-size: 18px; font-weight: 800;}
        .modal-box p { color: var(--text-muted); font-size: 14px; margin-bottom: 25px; line-height: 1.5; font-weight: 500;}
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-family: inherit; font-size: 13px; flex: 1; transition: 0.2s;}
        .modal-btn:hover { opacity: 0.9; transform: translateY(-1px);}
        .modal-btn-cancel { background: #f1f5f9; color: var(--text-main); }
        .modal-btn-confirm { background: var(--secondary); color: white; }
        .modal-btn-danger { background: #ef4444; color: white; }

        @media print {
            body { padding: 0; background: var(--white); }
            .app-container { display: block; max-width: none; margin: 0; }
            .controls { display: none; }
            .preview { box-shadow: none; margin: 0; width: 100%; min-height: auto; padding: 0; }
            .preview-content { padding: 10mm; } 
            .del-btn, .edit-btn, .action-col { display: none !important; }
            
            .modern-table th.total-col { border-top-right-radius: 6px !important; border-bottom-right-radius: 6px !important;}
            
            .summary-total, .modern-table th, .top-accent, .bank-details-box, .bank-logo-area, .warranty-badge, .modern-table tbody tr:nth-child(even) td, .info-card { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            
            .header-section { page-break-inside: avoid; }
            .info-grid { page-break-inside: avoid; }
            .summary-section { page-break-inside: avoid; }
            .bank-details-box { page-break-inside: avoid; }
            .bottom-section { page-break-inside: avoid; }
            #notesAreaContainer1, #notesAreaContainer2 { page-break-inside: avoid; }
            
            @page { margin: 5mm; }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="controls">
        <div class="profile-header">
            <select id="profileSelect" onchange="loadProfile()">
                </select>
            <button class="btn-save-profile" onclick="saveProfile()" title="Save current settings to this profile">üíæ Save Settings</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('editorTab', this)">üìù Invoice</button>
            <button class="tab-btn" onclick="switchTab('historyTab', this)">üìÑ History</button>
            <button class="tab-btn" onclick="switchTab('dbTab', this)">üóÑÔ∏è Database</button>
            <button class="tab-btn" onclick="switchTab('bankTab', this)">üè¶ Bank</button>
            <button class="tab-btn" onclick="switchTab('settingsTab', this)">üé® Settings</button>
        </div>

        <div id="editorTab" class="tab-content active">
            <div class="control-group">
                <h3>Document Details</h3>
                <div style="display: flex; gap: 10px;">
                    <select id="docType" onchange="handleDocTypeChange()" style="flex: 1;">
                        <option value="INVOICE">Invoice</option>
                        <option value="QUOTATION">Quotation</option>
                    </select>
                    <input type="text" id="docNo" oninput="updateView()" style="flex: 1.5;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;"><label>Date:</label><input type="date" id="docDate" oninput="handleDocDateChange()"></div>
                    <div style="flex: 1;" id="validDateControl"><label>Valid Until:</label><input type="date" id="validDate" oninput="updateView()"></div>
                </div>
            </div>

            <div class="control-group">
                <h3>Customer (Bill To)</h3>
                <input type="text" id="custName" list="custDatalist" placeholder="Search or Type Customer Name" oninput="autoFillCustomer(); updateView()">
                <datalist id="custDatalist"></datalist>
                <textarea id="custAddress" placeholder="Customer Address & Contact..." oninput="updateView()"></textarea>
            </div>

            <div class="control-group item-entry-box" id="itemInputBox">
                <h3 style="color: var(--primary);" id="itemEntryTitle">Add Item</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="itemName" list="itemDatalist" placeholder="Search or Type Item Name" style="flex: 2; margin-bottom: 0;" oninput="autoFillItem()">
                    <datalist id="itemDatalist"></datalist>
                    
                    <select id="itemWarrantySelect" onchange="handleWarrantyChange()" style="flex: 1; margin-bottom: 0;">
                        <option value="1 Year Warranty" selected>1 Year</option>
                        <option value="2 Years Warranty">2 Years</option>
                        <option value="3 Years Warranty">3 Years</option>
                        <option value="6 Months Warranty">6 Months</option>
                        <option value="3 Months Warranty">3 Months</option>
                        <option value="none">No Warranty</option>
                        <option value="custom">Custom...</option>
                    </select>
                </div>
                <input type="text" id="itemWarrantyCustom" placeholder="Type custom warranty here..." style="display: none; margin-bottom: 10px;">
                
                <textarea id="itemDesc" placeholder="Description / Serial No..."></textarea>
                
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1.5;"><label>Price (LKR)</label><input type="number" id="itemPrice" placeholder="0.00"></div>
                    <div style="flex: 1.5;"><label>Unit Discount</label><input type="number" id="itemDiscount" placeholder="0.00"></div>
                    <div style="flex: 1;"><label>Qty</label><input type="number" id="itemQty" value="1"></div>
                </div>
                <button class="btn btn-add" id="itemActionBtn" onclick="handleItemAction()">+ Add to List</button>
            </div>

            <div class="control-group" style="border:none;">
                <h3>Extra Information</h3>
                
                <label>Note Section 1 - Heading:</label>
                <input type="text" id="note1Heading" placeholder="e.g. Notes" oninput="updateView()">
                <textarea id="notes" placeholder="Payment terms, Bank Details..." oninput="updateView()"></textarea>
                
                <div style="margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 15px;">
                    <label>Note Section 2 - Heading (Optional):</label>
                    <input type="text" id="note2Heading" placeholder="e.g. Terms & Conditions" oninput="updateView()">
                    <textarea id="note2Text" placeholder="Add extra notes or terms here. Leave blank to hide." oninput="updateView()"></textarea>
                </div>
            </div>
        </div>

        <div id="historyTab" class="tab-content">
            <div class="control-group" style="border: none;">
                <h3>Saved Documents History</h3>
                <p style="font-size: 12px; color: var(--text-muted); margin-top:-10px;">All generated invoices are saved locally here. Click one to reload it.</p>
                
                <input type="text" id="histSearch" class="search-bar" placeholder="üîç Search by Customer Name or Doc No..." oninput="renderHistory()">
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <label>From Date</label>
                        <input type="date" id="histFrom" onchange="renderHistory()">
                    </div>
                    <div style="flex: 1;">
                        <label>To Date</label>
                        <input type="date" id="histTo" onchange="renderHistory()">
                    </div>
                    <div style="flex: 0.4; display:flex; align-items:flex-end;">
                        <button class="btn btn-add" style="padding: 10px; margin-bottom: 15px;" onclick="clearHistFilters()">Clear</button>
                    </div>
                </div>

                <div id="historyListContainer" style="max-height: 500px; overflow-y: auto; padding-right: 5px;">
                    </div>
            </div>
        </div>

        <div id="dbTab" class="tab-content">
            <div class="control-group">
                <h3>Customer Database</h3>
                <input type="text" id="searchCustDB" class="search-bar" placeholder="üîç Search Customers..." oninput="renderDBLists()">
                <input type="text" id="dbCustName" placeholder="Customer Name">
                <textarea id="dbCustAddress" placeholder="Customer Address & Contact Info"></textarea>
                <button class="btn btn-add" onclick="saveCustomerDB()">+ Save Customer</button>
                <div id="customerDBList" style="margin-top: 15px; max-height: 250px; overflow-y: auto;"></div>
            </div>

            <div class="control-group" style="border:none;">
                <h3>Item Database</h3>
                <input type="text" id="searchItemDB" class="search-bar" placeholder="üîç Search Items..." oninput="renderDBLists()">
                <input type="text" id="dbItemName" placeholder="Item Name">
                <textarea id="dbItemDesc" placeholder="Default Description"></textarea>
                <input type="number" id="dbItemPrice" placeholder="Default Price (LKR)">
                <button class="btn btn-add" onclick="saveItemDB()">+ Save Item</button>
                <div id="itemDBList" style="margin-top: 15px; max-height: 250px; overflow-y: auto;"></div>
            </div>
        </div>

        <div id="bankTab" class="tab-content">
            <div class="control-group" style="border:none;">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="showBank" onchange="updateView()" checked>
                    <label for="showBank"><strong>Show Bank Details on Invoice</strong></label>
                </div>

                <div id="bankInputs">
                    <label>Bank Logo Image (Square PNG/JPG):</label>
                    <input type="file" id="bankLogoInput" accept="image/*" onchange="loadBankLogo(event)" style="padding: 10px; background:#fff;">
                    
                    <label>Bank Name:</label>
                    <input type="text" id="bankName" placeholder="e.g. Commercial Bank" oninput="updateView()">
                    
                    <label>Account Name:</label>
                    <input type="text" id="accName" placeholder="e.g. NexaTag Solutions" oninput="updateView()">
                    
                    <label>Account Number:</label>
                    <input type="text" id="accNo" placeholder="e.g. 1000 2345 6789" oninput="updateView()">
                    
                    <label>Branch:</label>
                    <input type="text" id="bankBranch" placeholder="e.g. Kurunegala Branch" oninput="updateView()">
                </div>
            </div>
        </div>

        <div id="settingsTab" class="tab-content">
            
            <div class="control-group">
                <h3>Profile Management</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-add" style="padding: 10px;" onclick="addNewProfile()">‚ûï Add New Profile</button>
                    <button class="btn btn-add" style="padding: 10px;" onclick="renameCurrentProfile()">‚úèÔ∏è Rename Active</button>
                    <button class="btn" style="padding: 10px; background: #ef4444; border: none; flex: 0.5;" onclick="deleteCurrentProfile()">üóëÔ∏è Delete</button>
                </div>
            </div>

            <div class="control-group">
                <h3>Business Details (From)</h3>
                <input type="text" id="compName" placeholder="Business Name" oninput="updateView()">
                <textarea id="compAddress" placeholder="Address, Phone, Email..." oninput="updateView()"></textarea>
            </div>

            <div class="control-group">
                <h3>Theme Colors</h3>
                <p style="font-size: 12px; color: #64748b; margin-top: 0;">Keep it clean. Use your brand's main color as Primary.</p>
                <div class="color-row">
                    <div class="color-box">
                        <label>Primary (Main)</label>
                        <input type="color" id="primaryColor" oninput="updateTheme()">
                    </div>
                    <div class="color-box">
                        <label>Secondary (Accent Line)</label>
                        <input type="color" id="secondaryColor" oninput="updateTheme()">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h3>Company Logo</h3>
                <input type="file" id="logoInput" accept="image/*" onchange="loadLogo(event)" style="padding: 10px; background:#fff;">
                <label>Logo Size:</label>
                <input type="range" id="logoSize" min="50" max="300" value="140" oninput="updateTheme()">
            </div>

            <div class="control-group" style="border:none;">
                <h3>Signature Settings</h3>
                <select id="sigType" onchange="updateSignatureDisplay()">
                    <option value="upload">Upload Authorized Signature</option>
                    <option value="electronic">Electronic Text (No Signature)</option>
                </select>

                <div id="sigUploadControls" style="margin-top: 15px;">
                    <label>Upload Image (PNG):</label>
                    <input type="file" id="sigInput" accept="image/*" onchange="loadSignature(event)" style="padding: 10px; background:#fff;">
                    <label>Signature Size:</label>
                    <input type="range" id="sigSize" min="50" max="250" value="120" oninput="updateTheme()">
                </div>
            </div>
        </div>

        <button class="btn btn-print" onclick="initiatePrintAndSave()">Print & Save Document</button>
    </div>

    <div class="preview" id="printableArea">
        <div class="top-accent"></div>
        <div class="preview-content">
            
            <div class="header-section">
                <div class="logo-container">
                    <img id="logoPreview" src="" style="display:none;" alt="Logo">
                    <h2 id="logoTextFallback" style="margin:0; color:var(--primary); font-size: 28px; font-weight:800; letter-spacing:-1px;">Business Name</h2>
                </div>
                
                <div class="doc-title-wrapper">
                    <h1 class="doc-title" id="displayDocType">INVOICE</h1>
                    <div class="doc-number" id="displayDocNo">INV-1001</div>
                    
                    <div class="doc-dates">
                        <div class="date-line"><strong>Date:</strong> <span id="displayDate"></span></div>
                        <div class="date-line" id="displayValidDateArea" style="display:none;"><strong>Valid Until:</strong> <span id="displayValidDate"></span></div>
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <h4>From</h4>
                    <div class="info-title" id="displayCompName">Business Name</div>
                    <div class="info-text" id="displayCompAddress">-</div>
                </div>

                <div class="info-card">
                    <h4>Bill To</h4>
                    <div class="info-title" id="displayCustName">Customer Name</div>
                    <div class="info-text" id="displayCustAddress">-</div>
                </div>
            </div>

            <table class="modern-table">
                <thead id="tableHead">
                    </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>

            <div class="summary-section">
                <div class="summary-box">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="subTotal">LKR 0.00</span>
                    </div>
                    <div class="summary-row discount-row" id="discountRow" style="display: none;">
                        <span>Discount</span>
                        <span id="totalDiscountAmt">- LKR 0.00</span>
                    </div>
                    <div class="summary-total">
                        <span>Total Amount</span>
                        <span id="grandTotal">LKR 0.00</span>
                    </div>
                </div>
            </div>

            <div class="bank-details-box" id="bankDisplayBox" style="display: none;">
                <div class="bank-logo-area">
                    <img id="bankLogoPreview" src="" style="display:none;" alt="Bank">
                    <i id="bankLogoFallback">üè¶</i>
                </div>
                <div class="bank-info-area">
                    <h4>Payment Details</h4>
                    <div class="bank-info-line"><span>Bank:</span> <strong id="dispBankName">-</strong></div>
                    <div class="bank-info-line"><span>Account Name:</span> <strong id="dispAccName">-</strong></div>
                    <div class="bank-info-line"><span>Account No:</span> <strong id="dispAccNo">-</strong></div>
                    <div class="bank-info-line"><span>Branch:</span> <strong id="dispBranch">-</strong></div>
                </div>
            </div>

            <div class="bottom-section">
                <div class="notes-area">
                    <div id="notesAreaContainer1">
                        <h4 id="dispNote1Heading">Notes</h4>
                        <p id="displayNotes"></p>
                    </div>
                    <div id="notesAreaContainer2" style="margin-top: 15px; display: none;">
                        <h4 id="dispNote2Heading">Terms & Conditions</h4>
                        <p id="displayNote2Text"></p>
                    </div>
                </div>
                
                <div class="signature-area" id="sigAreaImage">
                    <div class="sig-image-container">
                        <img id="sigPreview" src="" style="display:none;" alt="Signature">
                    </div>
                    <div class="sig-line">Authorized Signature</div>
                </div>

                <div class="electronic-sig-text" id="sigAreaText" style="display:none;">
                    <p>This is an electronically generated document,<br>no signature is required.</p>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal-overlay" id="customModal">
    <div class="modal-box">
        <h3 id="modalTitle">Title</h3>
        <p id="modalMessage">Message goes here</p>
        <div class="modal-actions" id="modalActions">
        </div>
    </div>
</div>

<script>
    let itemsList = [];
    let editingIndex = -1;
    let editingDbCustIndex = -1;
    let editingDbItemIndex = -1;
    
    // DB & History Variables
    let customersDB = [];
    let productsDB = [];
    let docHistory = [];
    
    // Tracking Edit Mode
    let originalDocNo = null;

    // Profiles Data Management
    let profileList = [];
    const defaultProfileList = [
        { id: "biz1", name: "üè¢ NexaTag" },
        { id: "biz2", name: "üé® Hype Studio" },
        { id: "biz3", name: "üßæ Bill Mate" }
    ];

    const defaultProfilesSettings = {
        "biz1": {
            compName: "NexaTag",
            compAddress: "Kurunegala, Sri Lanka\nPhone: +94 77 123 4567\nEmail: info@nexatag.com",
            primaryColor: "#0f172a", secondaryColor: "#3b82f6", logoSize: 140, sigSize: 120, sigType: "upload",
            bankName: "Commercial Bank", accName: "NexaTag Solutions", accNo: "1000 0000 0000", bankBranch: "Kurunegala",
            note1Heading: "Notes", notes: "Thank you for your business!",
            note2Heading: "Terms & Conditions", note2Text: "Items cannot be returned after 14 days."
        },
        "biz2": {
            compName: "Hype Studio",
            compAddress: "Kurunegala, Sri Lanka\nPhone: +94 77 000 0000",
            primaryColor: "#e11d48", secondaryColor: "#fb7185", logoSize: 140, sigSize: 120, sigType: "electronic",
            bankName: "HNB", accName: "Hype Studio", accNo: "2000 0000 0000", bankBranch: "Kurunegala",
            note1Heading: "Payment Terms", notes: "Please pay within 7 days.",
            note2Heading: "", note2Text: ""
        },
        "biz3": {
            compName: "Bill Mate",
            compAddress: "Kurunegala, Sri Lanka\nPhone: +94 77 111 1111",
            primaryColor: "#065f46", secondaryColor: "#10b981", logoSize: 140, sigSize: 120, sigType: "electronic",
            bankName: "BOC", accName: "Bill Mate POS", accNo: "3000 0000 0000", bankBranch: "Kurunegala",
            note1Heading: "Notes", notes: "Cheques should be drawn in favor of 'Bill Mate'.",
            note2Heading: "", note2Text: ""
        }
    };
    
    function initApp() {
        // Load custom profile list or fall back to defaults
        let savedProfileList = localStorage.getItem('invoice_profile_list');
        profileList = savedProfileList ? JSON.parse(savedProfileList) : defaultProfileList;
        renderProfileDropdown();

        document.getElementById('docDate').valueAsDate = new Date();
        let nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 14);
        document.getElementById('validDate').valueAsDate = nextWeek;
        
        loadProfile(); 
        renderTable(); 
    }

    // --- PROFILE MANAGEMENT ---
    function renderProfileDropdown() {
        let select = document.getElementById('profileSelect');
        let currentVal = select.value;
        select.innerHTML = '';
        profileList.forEach(p => {
            let opt = document.createElement('option');
            opt.value = p.id;
            opt.innerText = p.name;
            select.appendChild(opt);
        });
        
        // Re-select previously active value if it still exists
        if (profileList.some(p => p.id === currentVal)) {
            select.value = currentVal;
        } else if (profileList.length > 0) {
            select.value = profileList[0].id; // Fallback to first
        }
    }

    function addNewProfile() {
        let name = prompt("Enter a name for the new profile (e.g., My New Shop):");
        if (!name || name.trim() === "") return;
        
        let newId = "biz_" + new Date().getTime(); // Unique ID
        profileList.push({ id: newId, name: name.trim() });
        localStorage.setItem('invoice_profile_list', JSON.stringify(profileList));
        
        // Generate an empty default settings block for it
        let newProfileData = { 
            compName: name.trim(), 
            primaryColor: "#0f172a", 
            secondaryColor: "#3b82f6", 
            logoSize: 140, 
            sigSize: 120, 
            sigType: "electronic" 
        };
        localStorage.setItem('invoice_profile_' + newId, JSON.stringify(newProfileData));
        
        renderProfileDropdown();
        document.getElementById('profileSelect').value = newId;
        loadProfile();
        showAlertModal("Success", `Profile '${name.trim()}' created successfully!`);
    }

    function renameCurrentProfile() {
        let activeId = document.getElementById('profileSelect').value;
        let profile = profileList.find(p => p.id === activeId);
        
        let newName = prompt("Enter new name for this profile:", profile.name);
        if (!newName || newName.trim() === "") return;
        
        profile.name = newName.trim();
        localStorage.setItem('invoice_profile_list', JSON.stringify(profileList));
        renderProfileDropdown();
    }

    function deleteCurrentProfile() {
        if (profileList.length <= 1) {
            return showAlertModal("Action Denied", "You must have at least one active profile. You cannot delete the only remaining profile.");
        }
        
        let activeId = document.getElementById('profileSelect').value;
        let profile = profileList.find(p => p.id === activeId);
        
        showConfirmModal(
            "Delete Profile", 
            `Are you sure you want to COMPLETELY delete the profile '${profile.name}'?\n\nThis will instantly delete ALL its saved settings, history, and customer/item databases!`, 
            "Yes, Delete", 
            "modal-btn-danger", 
            function() {
                // Remove from list
                profileList = profileList.filter(p => p.id !== activeId);
                localStorage.setItem('invoice_profile_list', JSON.stringify(profileList));
                
                // Erase local storage data
                localStorage.removeItem('invoice_profile_' + activeId);
                localStorage.removeItem('invoice_customers_db_' + activeId);
                localStorage.removeItem('invoice_products_db_' + activeId);
                localStorage.removeItem('invoice_history_' + activeId);
                
                renderProfileDropdown();
                loadProfile(); // Loads the next available one automatically
            }
        );
    }

    // --- DATE AUTO-CALCULATION ---
    function handleDocDateChange() {
        let docType = document.getElementById('docType').value;
        let dateVal = document.getElementById('docDate').value;
        
        if (docType === 'QUOTATION' && dateVal) {
            let d = new Date(dateVal);
            d.setDate(d.getDate() + 14); // Add exactly 2 weeks
            document.getElementById('validDate').valueAsDate = d;
        }
        updateView();
    }

    // --- SMART NUMBERING FUNCTION ---
    function getNextDocNo(type) {
        let maxNumber = 0;
        let bestPrefix = type === 'QUOTATION' ? 'QUO-' : 'INV-';
        let numberLength = 4; // Default padding e.g., 1001
        let found = false;

        for (let i = 0; i < docHistory.length; i++) {
            if (docHistory[i].docType === type) {
                let match = docHistory[i].docNo.match(/^(.*?)(\d+)$/);
                if (match) {
                    let num = parseInt(match[2], 10);
                    if (num > maxNumber) {
                        maxNumber = num;
                        bestPrefix = match[1];
                        numberLength = match[2].length;
                        found = true;
                    }
                }
            }
        }

        if (found) {
            let nextNumber = maxNumber + 1;
            return bestPrefix + String(nextNumber).padStart(numberLength, '0');
        }

        return type === 'QUOTATION' ? 'QUO-1001' : 'INV-1001';
    }

    // --- CUSTOM MODAL FUNCTIONS ---
    let modalCallback = null;
    function closeCustomModal() {
        document.getElementById('customModal').classList.remove('show');
    }
    function showAlertModal(title, msg) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        document.getElementById('modalActions').innerHTML = `<button class="modal-btn modal-btn-confirm" onclick="closeCustomModal()">OK</button>`;
        document.getElementById('customModal').classList.add('show');
    }
    function showConfirmModal(title, msg, confirmText, btnClass, callback) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        modalCallback = callback;
        document.getElementById('modalActions').innerHTML = `
            <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">Cancel</button>
            <button class="modal-btn ${btnClass}" onclick="executeModalCallback()">${confirmText}</button>
        `;
        document.getElementById('customModal').classList.add('show');
    }
    function executeModalCallback() {
        closeCustomModal();
        if(modalCallback) modalCallback();
    }

    // --- RESET FORM FUNCTION ---
    function resetInvoiceForm() {
        document.getElementById('custName').value = '';
        document.getElementById('custAddress').value = '';
        document.getElementById('docDate').valueAsDate = new Date();
        
        let nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 14);
        document.getElementById('validDate').valueAsDate = nextWeek;

        itemsList = [];
        editingIndex = -1;
        // DO NOT reset originalDocNo here! It is managed in the workflow.

        resetItemForm(); 
        renderTable();
    }

    // --- PRINT & SAVE LOGIC ---
    function initiatePrintAndSave() {
        let docNo = document.getElementById('docNo').value.trim();
        let docType = document.getElementById('docType').value;

        if(!docNo) return showAlertModal("Error", "Document Number cannot be empty!");
        if(itemsList.length === 0) return showAlertModal("Error", "Please add at least one item to the document!");

        let exists = docHistory.some(h => h.docNo === docNo);

        if (exists && originalDocNo !== docNo) {
            return showAlertModal("Duplicate Number Found", `Document Number ${docNo} already exists in the history!\n\nPlease use a different number or edit the existing one from the History tab.`);
        }

        let title = exists ? "Update Document" : "Save Document";
        let msg = exists ? "Are you sure you want to update this existing document in the history?" : "Are you sure you want to save and print this new document?";
        let btnText = exists ? "Yes, Update" : "Yes, Save";

        showConfirmModal(title, msg, btnText, "modal-btn-confirm", function() {
            // Save to history
            saveToHistory();
            
            // Print
            window.print();
            
            // Clear edit mode entirely
            originalDocNo = null; 

            // Clear the form and set up for the NEXT new document
            resetInvoiceForm();
            handleDocTypeChange(); // Will auto-fetch the actual next available number
            updateView();
        });
    }

    function saveToHistory() {
        let activeBiz = document.getElementById('profileSelect').value;
        let docNo = document.getElementById('docNo').value;

        let entry = {
            docNo: docNo,
            docType: document.getElementById('docType').value,
            date: document.getElementById('docDate').value,
            validDate: document.getElementById('validDate').value,
            custName: document.getElementById('custName').value || 'Unknown Customer',
            custAddress: document.getElementById('custAddress').value,
            total: document.getElementById('grandTotal').innerText,
            items: JSON.parse(JSON.stringify(itemsList)),
            timestamp: new Date().getTime()
        };

        let existingIndex = docHistory.findIndex(h => h.docNo === docNo);
        if (existingIndex >= 0) {
            docHistory[existingIndex] = entry; // Update
        } else {
            docHistory.push(entry); // Add New
        }

        localStorage.setItem('invoice_history_' + activeBiz, JSON.stringify(docHistory));
        renderHistory();
    }

    // --- HISTORY MANAGEMENT FUNCTIONS ---
    function renderHistory() {
        let searchTerm = (document.getElementById('histSearch').value || '').toLowerCase();
        let fromDate = document.getElementById('histFrom').value;
        let toDate = document.getElementById('histTo').value;

        let sortedHistory = [...docHistory].sort((a, b) => b.timestamp - a.timestamp);
        let html = '';
        
        sortedHistory.forEach((h, index) => {
            let matchSearch = h.custName.toLowerCase().includes(searchTerm) || h.docNo.toLowerCase().includes(searchTerm);
            let matchFrom = fromDate ? (new Date(h.date) >= new Date(fromDate)) : true;
            let matchTo = toDate ? (new Date(h.date) <= new Date(toDate)) : true;

            if (matchSearch && matchFrom && matchTo) {
                let badgeClass = h.docType === 'QUOTATION' ? 'hist-badge quo' : 'hist-badge';
                let originalIndex = docHistory.findIndex(orig => orig.docNo === h.docNo);

                html += `
                <div class="hist-card" onclick="loadHistoryItem(${originalIndex})">
                    <div class="hist-info">
                        <h4>${h.custName}</h4>
                        <p>${h.docNo} ‚Ä¢ ${formatDate(h.date)}</p>
                    </div>
                    <div class="hist-meta">
                        <span class="hist-total">${h.total}</span>
                        <div style="margin-top: 5px; display: flex; justify-content: flex-end; gap: 10px; align-items: center;">
                            <span class="${badgeClass}">${h.docType}</span>
                            <button class="del-btn" style="opacity:1; padding: 0;" onclick="deleteHistoryItem(event, '${h.docNo}')" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>`;
            }
        });

        if(html === '') {
            html = '<p style="text-align:center; color:var(--text-muted); font-size:13px; margin-top:20px;">No documents found matching the criteria.</p>';
        }

        document.getElementById('historyListContainer').innerHTML = html;
    }

    function loadHistoryItem(index) {
        let h = docHistory[index];
        if(!h) return;

        document.getElementById('docType').value = h.docType;
        document.getElementById('docNo').value = h.docNo;
        document.getElementById('docDate').value = h.date;
        document.getElementById('validDate').value = h.validDate || '';
        document.getElementById('custName').value = h.custName !== 'Unknown Customer' ? h.custName : '';
        document.getElementById('custAddress').value = h.custAddress || '';

        itemsList = JSON.parse(JSON.stringify(h.items));
        
        // Mark as editing this document
        originalDocNo = h.docNo;
        
        // Don't auto-generate next number while editing
        document.getElementById('displayDocType').innerText = h.docType;
        if(h.docType === 'QUOTATION') {
            document.getElementById('validDateControl').style.display = 'block';
            document.getElementById('displayValidDateArea').style.display = 'block'; 
        } else {
            document.getElementById('validDateControl').style.display = 'none';
            document.getElementById('displayValidDateArea').style.display = 'none'; 
        }

        renderTable();
        updateView();

        switchTab('editorTab', document.querySelectorAll('.tab-btn')[0]);
    }

    function deleteHistoryItem(event, docNoToDelete) {
        event.stopPropagation(); 
        
        showConfirmModal(
            "Delete Document", 
            `Are you sure you want to permanently delete document ${docNoToDelete}?`, 
            "Delete", 
            "modal-btn-danger", 
            function() {
                let activeBiz = document.getElementById('profileSelect').value;
                docHistory = docHistory.filter(h => h.docNo !== docNoToDelete);
                localStorage.setItem('invoice_history_' + activeBiz, JSON.stringify(docHistory));
                
                // If currently editing the deleted item, reset back to new form
                if (originalDocNo === docNoToDelete) {
                    originalDocNo = null; 
                    resetInvoiceForm();
                    handleDocTypeChange(); // Load the fresh next number
                }
                
                renderHistory();
            }
        );
    }

    function clearHistFilters() {
        document.getElementById('histSearch').value = '';
        document.getElementById('histFrom').value = '';
        document.getElementById('histTo').value = '';
        renderHistory();
    }

    // --- DB MANAGEMENT FUNCTIONS ---
    function renderDBLists() {
        let custSearchTerm = (document.getElementById('searchCustDB')?.value || '').toLowerCase();
        let itemSearchTerm = (document.getElementById('searchItemDB')?.value || '').toLowerCase();

        let custDataListHTML = '';
        let custUIHTML = '';
        customersDB.forEach((c, index) => {
            custDataListHTML += `<option value="${c.name}">`;
            
            if (c.name.toLowerCase().includes(custSearchTerm) || c.address.toLowerCase().includes(custSearchTerm)) {
                custUIHTML += `<div class="db-list-item">
                    <div><strong style="color:var(--primary);">${c.name}</strong><br><span style="color:var(--text-muted);">${c.address}</span></div>
                    <div>
                        <button class="edit-btn" style="opacity:1;" onclick="editCustomerDB(${index})" title="Edit Customer">‚úèÔ∏è</button>
                        <button class="del-btn" style="opacity:1;" onclick="deleteCustomerDB(${index})" title="Delete Customer">‚úñ</button>
                    </div>
                </div>`;
            }
        });
        document.getElementById('custDatalist').innerHTML = custDataListHTML;
        document.getElementById('customerDBList').innerHTML = custUIHTML;

        let prodDataListHTML = '';
        let prodUIHTML = '';
        productsDB.forEach((p, index) => {
            prodDataListHTML += `<option value="${p.name}">`;
            
            if (p.name.toLowerCase().includes(itemSearchTerm) || (p.desc && p.desc.toLowerCase().includes(itemSearchTerm))) {
                prodUIHTML += `<div class="db-list-item">
                    <div><strong style="color:var(--primary);">${p.name}</strong><br><span style="color:var(--secondary); font-weight:700;">LKR ${formatMoney(p.price)}</span></div>
                    <div>
                        <button class="edit-btn" style="opacity:1;" onclick="editItemDB(${index})" title="Edit Item">‚úèÔ∏è</button>
                        <button class="del-btn" style="opacity:1;" onclick="deleteItemDB(${index})" title="Delete Item">‚úñ</button>
                    </div>
                </div>`;
            }
        });
        document.getElementById('itemDatalist').innerHTML = prodDataListHTML;
        document.getElementById('itemDBList').innerHTML = prodUIHTML;
    }

    function editCustomerDB(index) {
        let cust = customersDB[index];
        document.getElementById('dbCustName').value = cust.name;
        document.getElementById('dbCustAddress').value = cust.address;
        
        editingDbCustIndex = index;
        let btn = document.querySelector('#dbTab .control-group:nth-child(1) .btn-add');
        btn.innerHTML = "‚úì Update Customer";
        btn.style.background = "var(--secondary)";
        btn.style.color = "var(--white)";
    }

    function editItemDB(index) {
        let item = productsDB[index];
        document.getElementById('dbItemName').value = item.name;
        document.getElementById('dbItemDesc').value = item.desc;
        document.getElementById('dbItemPrice').value = item.price;
        
        editingDbItemIndex = index;
        let btn = document.querySelector('#dbTab .control-group:nth-child(2) .btn-add');
        btn.innerHTML = "‚úì Update Item";
        btn.style.background = "var(--secondary)";
        btn.style.color = "var(--white)";
    }

    function deleteCustomerDB(index) {
        let activeBiz = document.getElementById('profileSelect').value;
        customersDB.splice(index, 1);
        localStorage.setItem('invoice_customers_db_' + activeBiz, JSON.stringify(customersDB));
        renderDBLists();
    }

    function saveCustomerDB() {
        let activeBiz = document.getElementById('profileSelect').value;
        let name = document.getElementById('dbCustName').value.trim();
        let address = document.getElementById('dbCustAddress').value.trim();
        if(!name) return showAlertModal("Error", "Customer Name is required to save.");
        
        if (editingDbCustIndex !== -1) {
            customersDB[editingDbCustIndex] = {name, address};
            editingDbCustIndex = -1;
            let btn = document.querySelector('#dbTab .control-group:nth-child(1) .btn-add');
            btn.innerHTML = "+ Save Customer";
            btn.style.background = "var(--white)";
            btn.style.color = "var(--primary)";
        } else {
            let existingIndex = customersDB.findIndex(c => c.name === name);
            if(existingIndex !== -1) customersDB[existingIndex] = {name, address};
            else customersDB.push({name, address});
        }
        
        localStorage.setItem('invoice_customers_db_' + activeBiz, JSON.stringify(customersDB));
        document.getElementById('dbCustName').value = '';
        document.getElementById('dbCustAddress').value = '';
        renderDBLists();
    }

    function saveItemDB() {
        let activeBiz = document.getElementById('profileSelect').value;
        let name = document.getElementById('dbItemName').value.trim();
        let desc = document.getElementById('dbItemDesc').value.trim();
        let price = parseFloat(document.getElementById('dbItemPrice').value) || 0;
        if(!name) return showAlertModal("Error", "Item Name is required to save.");

        if (editingDbItemIndex !== -1) {
            productsDB[editingDbItemIndex] = {name, desc, price};
            editingDbItemIndex = -1;
            let btn = document.querySelector('#dbTab .control-group:nth-child(2) .btn-add');
            btn.innerHTML = "+ Save Item";
            btn.style.background = "var(--white)";
            btn.style.color = "var(--primary)";
        } else {
            let existingIndex = productsDB.findIndex(p => p.name === name);
            if(existingIndex !== -1) productsDB[existingIndex] = {name, desc, price};
            else productsDB.push({name, desc, price});
        }

        localStorage.setItem('invoice_products_db_' + activeBiz, JSON.stringify(productsDB));
        document.getElementById('dbItemName').value = '';
        document.getElementById('dbItemDesc').value = '';
        document.getElementById('dbItemPrice').value = '';
        renderDBLists();
    }

    function deleteItemDB(index) {
        let activeBiz = document.getElementById('profileSelect').value;
        productsDB.splice(index, 1);
        localStorage.setItem('invoice_products_db_' + activeBiz, JSON.stringify(productsDB));
        renderDBLists();
    }

    function autoFillCustomer() {
        let currentName = document.getElementById('custName').value;
        let match = customersDB.find(c => c.name === currentName);
        if(match) {
            document.getElementById('custAddress').value = match.address;
        }
    }

    function autoFillItem() {
        let currentName = document.getElementById('itemName').value;
        let match = productsDB.find(p => p.name === currentName);
        if(match) {
            document.getElementById('itemPrice').value = match.price;
            if(match.desc) document.getElementById('itemDesc').value = match.desc;
        }
    }

    // --- MAIN APP FUNCTIONS ---
    function loadProfile() {
        let activeBiz = document.getElementById('profileSelect').value;
        if (!activeBiz) return; // Prevent errors if no profile exists yet
        
        let savedData = localStorage.getItem('invoice_profile_' + activeBiz);
        // Fallback to defaults or a totally blank profile template
        let profile = savedData ? JSON.parse(savedData) : (defaultProfilesSettings[activeBiz] || {
            compName: "New Business", primaryColor: "#0f172a", secondaryColor: "#3b82f6", logoSize: 140, sigSize: 120, sigType: "electronic"
        });

        document.getElementById('compName').value = profile.compName || '';
        document.getElementById('compAddress').value = profile.compAddress || '';
        document.getElementById('primaryColor').value = profile.primaryColor || '#0f172a';
        document.getElementById('secondaryColor').value = profile.secondaryColor || '#3b82f6';
        document.getElementById('logoSize').value = profile.logoSize || 140;
        document.getElementById('sigSize').value = profile.sigSize || 120;
        document.getElementById('sigType').value = profile.sigType || 'upload';
        
        document.getElementById('bankName').value = profile.bankName || '';
        document.getElementById('accName').value = profile.accName || '';
        document.getElementById('accNo').value = profile.accNo || '';
        document.getElementById('bankBranch').value = profile.bankBranch || '';
        
        document.getElementById('note1Heading').value = profile.note1Heading !== undefined ? profile.note1Heading : 'Notes';
        document.getElementById('notes').value = profile.notes || '';
        document.getElementById('note2Heading').value = profile.note2Heading !== undefined ? profile.note2Heading : 'Terms & Conditions';
        document.getElementById('note2Text').value = profile.note2Text || '';

        if(profile.logoBase64) {
            document.getElementById('logoPreview').src = profile.logoBase64;
            document.getElementById('logoPreview').style.display = 'block';
            document.getElementById('logoTextFallback').style.display = 'none';
        } else {
            document.getElementById('logoPreview').style.display = 'none';
            document.getElementById('logoTextFallback').style.display = 'block';
        }

        if(profile.bankLogoBase64) {
            document.getElementById('bankLogoPreview').src = profile.bankLogoBase64;
            document.getElementById('bankLogoPreview').style.display = 'block';
            document.getElementById('bankLogoFallback').style.display = 'none';
        } else {
            document.getElementById('bankLogoPreview').style.display = 'none';
            document.getElementById('bankLogoFallback').style.display = 'block';
        }

        if(profile.sigBase64) {
            document.getElementById('sigPreview').src = profile.sigBase64;
            document.getElementById('sigPreview').style.display = 'block';
        } else {
            document.getElementById('sigPreview').style.display = 'none';
        }

        updateTheme();
        updateSignatureDisplay();

        // Reset edit tracking when changing profile
        originalDocNo = null;

        customersDB = JSON.parse(localStorage.getItem('invoice_customers_db_' + activeBiz)) || [];
        productsDB = JSON.parse(localStorage.getItem('invoice_products_db_' + activeBiz)) || [];
        docHistory = JSON.parse(localStorage.getItem('invoice_history_' + activeBiz)) || [];
        
        renderDBLists();
        renderHistory();

        // Automatically set the correct next number based on newly loaded history
        handleDocTypeChange();
    }

    function saveProfile() {
        let activeBiz = document.getElementById('profileSelect').value;
        
        let profileToSave = {
            compName: document.getElementById('compName').value,
            compAddress: document.getElementById('compAddress').value,
            primaryColor: document.getElementById('primaryColor').value,
            secondaryColor: document.getElementById('secondaryColor').value,
            logoSize: document.getElementById('logoSize').value,
            sigSize: document.getElementById('sigSize').value,
            sigType: document.getElementById('sigType').value,
            bankName: document.getElementById('bankName').value,
            accName: document.getElementById('accName').value,
            accNo: document.getElementById('accNo').value,
            bankBranch: document.getElementById('bankBranch').value,
            note1Heading: document.getElementById('note1Heading').value,
            notes: document.getElementById('notes').value,
            note2Heading: document.getElementById('note2Heading').value,
            note2Text: document.getElementById('note2Text').value,
            
            logoBase64: document.getElementById('logoPreview').style.display === 'block' ? document.getElementById('logoPreview').src : null,
            bankLogoBase64: document.getElementById('bankLogoPreview').style.display === 'block' ? document.getElementById('bankLogoPreview').src : null,
            sigBase64: document.getElementById('sigPreview').style.display === 'block' ? document.getElementById('sigPreview').src : null
        };

        try {
            localStorage.setItem('invoice_profile_' + activeBiz, JSON.stringify(profileToSave));
            showAlertModal("Success", "Settings Saved Successfully for this profile!");
        } catch (e) {
            showAlertModal("Error", "Error saving profile. Images might be too large.");
        }
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function updateTheme() {
        let pColor = document.getElementById('primaryColor').value;
        let sColor = document.getElementById('secondaryColor').value;
        
        let r = parseInt(pColor.slice(1, 3), 16);
        let g = parseInt(pColor.slice(3, 5), 16);
        let b = parseInt(pColor.slice(5, 7), 16);
        
        let rowLightBg = `rgba(${r}, ${g}, ${b}, 0.03)`; 
        let fadeBg = `rgba(${r}, ${g}, ${b}, 0.05)`;     

        document.documentElement.style.setProperty('--primary', pColor);
        document.documentElement.style.setProperty('--secondary', sColor);
        document.documentElement.style.setProperty('--row-alt-bg', rowLightBg);
        document.documentElement.style.setProperty('--theme-fade', fadeBg);
        document.documentElement.style.setProperty('--logo-width', document.getElementById('logoSize').value + 'px');
        document.documentElement.style.setProperty('--sign-width', document.getElementById('sigSize').value + 'px');
    }

    function updateSignatureDisplay() {
        let type = document.getElementById('sigType').value;
        if (type === 'electronic') {
            document.getElementById('sigUploadControls').style.display = 'none';
            document.getElementById('sigAreaImage').style.display = 'none';
            document.getElementById('sigAreaText').style.display = 'block';
        } else {
            document.getElementById('sigUploadControls').style.display = 'block';
            document.getElementById('sigAreaImage').style.display = 'block';
            document.getElementById('sigAreaText').style.display = 'none';
        }
    }

    function loadFile(event, previewId, fallbackId = null) {
        let reader = new FileReader();
        reader.onload = function() {
            let output = document.getElementById(previewId);
            output.src = reader.result;
            output.style.display = 'block';
            if(fallbackId) document.getElementById(fallbackId).style.display = 'none';
        };
        if(event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
    }
    function loadLogo(e) { loadFile(e, 'logoPreview', 'logoTextFallback'); }
    function loadSignature(e) { loadFile(e, 'sigPreview'); }
    function loadBankLogo(e) { loadFile(e, 'bankLogoPreview', 'bankLogoFallback'); updateView(); }

    function handleDocTypeChange() {
        let type = document.getElementById('docType').value;
        let noInput = document.getElementById('docNo');
        
        // Auto fetch the next number ONLY if we are NOT in edit mode
        if (!originalDocNo) {
            noInput.value = getNextDocNo(type);
        }

        if(type === 'QUOTATION') {
            document.getElementById('validDateControl').style.display = 'block';
            document.getElementById('displayValidDateArea').style.display = 'block'; 
            
            // Re-trigger date calculation just in case
            handleDocDateChange();
        } else {
            document.getElementById('validDateControl').style.display = 'none';
            document.getElementById('displayValidDateArea').style.display = 'none'; 
        }
        updateView();
    }

    function formatDate(dateStr) {
        if(!dateStr) return '';
        const options = { year: 'numeric', month: 'short', day: '2-digit' };
        return new Date(dateStr).toLocaleDateString('en-GB', options);
    }

    function updateView() {
        document.getElementById('displayDocType').innerText = document.getElementById('docType').value;
        
        let docNum = document.getElementById('docNo').value;
        document.getElementById('displayDocNo').innerText = docNum;
        
        document.getElementById('displayDate').innerText = formatDate(document.getElementById('docDate').value);
        document.getElementById('displayValidDate').innerText = formatDate(document.getElementById('validDate').value);
        
        let cName = document.getElementById('compName').value;
        document.getElementById('displayCompName').innerText = cName || 'Business Name';
        document.getElementById('logoTextFallback').innerText = cName || 'Business Name';
        document.getElementById('displayCompAddress').innerText = document.getElementById('compAddress').value;
        
        let custName = document.getElementById('custName').value;
        document.getElementById('displayCustName').innerText = custName || 'Customer Name';
        document.getElementById('displayCustAddress').innerText = document.getElementById('custAddress').value;
        
        let n1Heading = document.getElementById('note1Heading').value || 'Notes';
        let n1Text = document.getElementById('notes').value;
        document.getElementById('dispNote1Heading').innerText = n1Heading;
        document.getElementById('displayNotes').innerText = n1Text;
        document.getElementById('notesAreaContainer1').style.display = n1Text.trim() ? 'block' : 'none';

        let n2Heading = document.getElementById('note2Heading').value || 'Terms & Conditions';
        let n2Text = document.getElementById('note2Text').value;
        document.getElementById('dispNote2Heading').innerText = n2Heading;
        document.getElementById('displayNote2Text').innerText = n2Text;
        document.getElementById('notesAreaContainer2').style.display = n2Text.trim() ? 'block' : 'none';

        let showBank = document.getElementById('showBank').checked;
        if(showBank) {
            document.getElementById('bankDisplayBox').style.display = 'flex';
            document.getElementById('dispBankName').innerText = document.getElementById('bankName').value || '-';
            document.getElementById('dispAccName').innerText = document.getElementById('accName').value || '-';
            document.getElementById('dispAccNo').innerText = document.getElementById('accNo').value || '-';
            document.getElementById('dispBranch').innerText = document.getElementById('bankBranch').value || '-';
        } else {
            document.getElementById('bankDisplayBox').style.display = 'none';
        }

        let finalCustName = custName ? custName : 'Customer';
        let finalDocNum = docNum ? docNum : 'Invoice';
        
        document.title = `${finalCustName} - ${finalDocNum}`;
    }

    function handleWarrantyChange() {
        let val = document.getElementById('itemWarrantySelect').value;
        if(val === 'custom') {
            document.getElementById('itemWarrantyCustom').style.display = 'block';
        } else {
            document.getElementById('itemWarrantyCustom').style.display = 'none';
        }
    }

    function editItem(index) {
        let item = itemsList[index];
        
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemDesc').value = item.desc;
        document.getElementById('itemPrice').value = item.price;
        document.getElementById('itemDiscount').value = item.discount || '';
        document.getElementById('itemQty').value = item.qty;

        let wSelect = document.getElementById('itemWarrantySelect');
        let wCustom = document.getElementById('itemWarrantyCustom');
        let predefined = ["1 Year Warranty", "2 Years Warranty", "3 Years Warranty", "6 Months Warranty", "3 Months Warranty"];
        
        if (!item.warranty || item.warranty === "") {
            wSelect.value = "none";
            wCustom.style.display = "none";
        } else if (predefined.includes(item.warranty)) {
            wSelect.value = item.warranty;
            wCustom.style.display = "none";
        } else {
            wSelect.value = "custom";
            wCustom.style.display = "block";
            wCustom.value = item.warranty;
        }

        editingIndex = index;
        
        let btn = document.getElementById('itemActionBtn');
        btn.innerHTML = "‚úì Update Item";
        btn.style.background = "var(--secondary)";
        btn.style.color = "var(--white)";
        document.getElementById('itemEntryTitle').innerText = "Edit Item";
        
        document.getElementById('itemInputBox').style.borderColor = "var(--secondary)";
        document.getElementById('itemInputBox').style.boxShadow = "0 0 0 3px rgba(59, 130, 246, 0.1)";

        switchTab('editorTab', document.querySelectorAll('.tab-btn')[0]);
    }

    function resetItemForm() {
        document.getElementById('itemName').value = '';
        document.getElementById('itemDesc').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemDiscount').value = '';
        document.getElementById('itemQty').value = '1';
        
        editingIndex = -1;
        
        let btn = document.getElementById('itemActionBtn');
        btn.innerHTML = "+ Add to List";
        btn.style.background = "var(--white)";
        btn.style.color = "var(--primary)";
        document.getElementById('itemEntryTitle').innerText = "Add Item";
        
        document.getElementById('itemInputBox').style.borderColor = "var(--border)";
        document.getElementById('itemInputBox').style.boxShadow = "none";
    }

    function handleItemAction() {
        let name = document.getElementById('itemName').value;
        let desc = document.getElementById('itemDesc').value;
        let price = parseFloat(document.getElementById('itemPrice').value) || 0;
        let discount = parseFloat(document.getElementById('itemDiscount').value) || 0;
        let qty = parseFloat(document.getElementById('itemQty').value) || 1;

        if (name.trim() === "" || price === 0) return showAlertModal("Missing Info", "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª Item Name ‡∑É‡∑Ñ Price ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");
        if (discount > price) return showAlertModal("Invalid Discount", "Discount ‡∂ë‡∂ö ‡∂∑‡∑è‡∂´‡∑ä‡∂©‡∂∫‡∑ö ‡∂∏‡∑í‡∂Ω‡∂ß ‡∑Ä‡∂©‡∑è ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∂∫ ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö!");

        let wSelect = document.getElementById('itemWarrantySelect').value;
        let warranty = '';
        if (wSelect === 'custom') {
            warranty = document.getElementById('itemWarrantyCustom').value;
        } else if (wSelect !== 'none') {
            warranty = wSelect;
        }

        let newItem = { name, desc, warranty, price, discount, qty };

        if (editingIndex === -1) {
            itemsList.push(newItem);
        } else {
            itemsList[editingIndex] = newItem;
        }

        resetItemForm();
        renderTable();
    }

    function deleteItem(index) {
        itemsList.splice(index, 1);
        
        if (editingIndex === index) {
            resetItemForm();
        } else if (editingIndex > index) {
            editingIndex--; 
        }
        
        renderTable();
    }

    function formatMoney(amount) {
        return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function renderTable() {
        let hasDiscount = itemsList.some(item => item.discount > 0);
        
        let theadHTML = `
            <tr>
                <th style="width: ${hasDiscount ? '40%' : '50%'};">Description</th>
                <th class="text-center" style="width: 10%;">Qty</th>
                <th class="text-right" style="width: 15%;">Rate</th>
                ${hasDiscount ? '<th class="text-right" style="width: 15%;">Disc.</th>' : ''}
                <th class="text-right total-col" style="width: 20%;">Total</th>
                <th class="action-col"></th>
            </tr>
        `;
        document.getElementById('tableHead').innerHTML = theadHTML;

        let tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        let grossTotal = 0;
        let totalDiscount = 0;

        itemsList.forEach((item, index) => {
            let itemGross = item.price * item.qty;
            let itemDiscTotal = item.discount * item.qty;
            let itemNet = itemGross - itemDiscTotal;
            
            grossTotal += itemGross;
            totalDiscount += itemDiscTotal;

            let wBadge = item.warranty ? `<div class="warranty-badge">${item.warranty}</div>` : '';
            let dCell = hasDiscount ? `<td class="text-right">${item.discount > 0 ? formatMoney(item.discount) : '-'}</td>` : '';
            
            let row = `<tr>
                <td>
                    <span class="item-main">${item.name}</span>
                    ${item.desc ? `<span class="item-sub">${item.desc}</span>` : ''}
                    ${wBadge}
                </td>
                <td class="text-center">${item.qty}</td>
                <td class="text-right">${formatMoney(item.price)}</td>
                ${dCell}
                <td class="text-right" style="font-weight:600; color:var(--text-main);">${formatMoney(itemNet)}</td>
                <td class="action-col">
                    <button class="edit-btn" onclick="editItem(${index})" title="Edit Item">‚úèÔ∏è</button>
                    <button class="del-btn" onclick="deleteItem(${index})" title="Delete Item">‚úñ</button>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        document.getElementById('subTotal').innerText = 'LKR ' + formatMoney(grossTotal);
        
        if (totalDiscount > 0) {
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('totalDiscountAmt').innerText = '- LKR ' + formatMoney(totalDiscount);
        } else {
            document.getElementById('discountRow').style.display = 'none';
        }

        let netFinal = grossTotal - totalDiscount;
        document.getElementById('grandTotal').innerText = 'LKR ' + formatMoney(netFinal);
    }

    document.addEventListener("DOMContentLoaded", initApp);
    if (document.readyState === "complete" || document.readyState === "interactive") initApp();

</script>

</body>
</html>